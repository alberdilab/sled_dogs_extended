# With wolves and dogs

```{r load_data_beta_wolves, comment="", message=FALSE, warning=FALSE}
load("data/data.Rdata")

sample_metadata <- read_csv("data/sample_metadata.csv")
 
sample_metadata$individual <- sub("[0-9]{2}$", "", sample_metadata$animal)

sample_metadata_illu <- read_csv("data/metadata_illu.csv")
sample_metadata <- sample_metadata %>% 
  left_join(sample_metadata_illu[c(1,4,9)], by=join_by("sample"=="DogID")) 

load("data/beta.Rdata")
#samples to remove
samples_to_remove <- sample_metadata %>% 
  filter(Samples %in% c("Blank", "Saliva") | group2 %in% c("Unknown") | season=="winter" | !day %in% c("day_1", "Unknown") | individual == "GL_02_") %>% #
  select(sample) %>% 
  pull()

beta_q1n_mat <- as.matrix(beta_q1n$S)
beta_q1n_filtered <- beta_q1n_mat[!rownames(beta_q1n_mat) %in% samples_to_remove,
                        !colnames(beta_q1n_mat) %in% samples_to_remove]
beta_q1n <- as.dist(beta_q1n_filtered)

sample_metadata <- sample_metadata %>% 
  filter(!sample %in% samples_to_remove)
  #filter(individual != "GL_02_" | !Samples %in% c("Blank", "Saliva") | group2 != "Unknown" | season!="winter") 

genome_counts_filt <- genome_counts_filt %>% 
  select(one_of(c("genome",sample_metadata$sample)))%>%
  filter(rowSums(. != 0, na.rm = TRUE) > 0) %>%
  select_if(~!all(. == 0))

genome_metadata <- genome_metadata %>% 
  semi_join(., genome_counts_filt, by = "genome") %>% 
  arrange(match(genome,genome_counts_filt$genome))

genome_tree <- keep.tip(genome_tree, tip=genome_metadata$genome)
```

```{r gift_analysis, comment="", echo=FALSE, message=FALSE, warning=FALSE}
genome_counts_filt <- genome_counts_filt[genome_counts_filt$genome %in% rownames(genome_gifts),]
genome_counts_filt <- genome_counts_filt %>%
    select(genome, all_of(sample_metadata$sample)) %>%
  column_to_rownames(., "genome") %>%
  filter(rowSums(. != 0, na.rm = TRUE) > 0) %>%
  select_if(~!all(. == 0))%>%
  rownames_to_column(., "genome")

genome_gifts <- genome_gifts[rownames(genome_gifts) %in% genome_counts_filt$genome,]
genome_gifts <- genome_gifts[, colSums(genome_gifts != 0) > 0]

#Aggregate bundle-level GIFTs into the compound level
GIFTs_elements <- to.elements(genome_gifts,GIFT_db)
GIFTs_elements_filtered <- GIFTs_elements[rownames(GIFTs_elements) %in% genome_counts_filt$genome,]
GIFTs_elements_filtered <- as.data.frame(GIFTs_elements_filtered) %>% 
  select_if(~ !is.numeric(.) || sum(.) != 0)

#Aggregate element-level GIFTs into the function level
GIFTs_functions <- to.functions(GIFTs_elements_filtered,GIFT_db)

#Aggregate function-level GIFTs into overall Biosynthesis, Degradation and Structural GIFTs
GIFTs_domains <- to.domains(GIFTs_functions,GIFT_db)

#Get community-weighed average GIFTs per sample
genome_counts_row <- genome_counts_filt %>%
  mutate_at(vars(-genome),~./sum(.)) %>% 
  column_to_rownames(., "genome") 
# genome_counts_row <- rownames_to_column(genome_counts_row, "genome")
GIFTs_elements_community <- to.community(GIFTs_elements_filtered,genome_counts_row,GIFT_db)
GIFTs_functions_community <- to.community(GIFTs_functions,genome_counts_row,GIFT_db)
GIFTs_domains_community <- to.community(GIFTs_domains,genome_counts_row,GIFT_db)
```

**Neutral**
```{r}
neutral <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(neutral = 1) %>%
  rownames_to_column(var = "sample")%>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
  ggplot(aes(y = neutral, x = group2, group=group2, color=group2, fill=group2)) +
      geom_jitter(width = 0.3, show.legend = FALSE) +
      geom_boxplot(width = 0.7, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(face = "bold", size = 12),
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(y = "Alpha diversity (neutral)")

png(filename="alpha_all.png", width = 980, height = 580,)
plot(neutral)
dev.off()
```

```{r beta_div_neutral_wolves, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=20, fig.fullwidth=TRUE}
nmds_all1 <- beta_q1n %>%
  vegan::metaMDS(., trymax = 500, k = 2, trace=0) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %>%
  group_by(group1) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = NMDS1, y = NMDS2, color = group1)) +
    geom_point(size = 4) +
    geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9, show.legend = FALSE) +
    theme_classic() +
    theme(
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(face = "bold", size = 12),
      panel.background = element_blank(),
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 14),
      legend.position = "right", legend.box = "vertical"
    ) +
  labs(color='Group')
# +
#   geom_text_repel(aes(label = individual), size=3)

png(filename="nmds1_all.png", width = 980, height = 780,)
plot(nmds_all1)
dev.off()
```



```{r permanova_q1_wolves, comment="", message=FALSE, warning=FALSE}
sample_metadata_row<- column_to_rownames(sample_metadata, "sample") 
sample_metadata_row <- sample_metadata_row[labels(beta_q1n), ]
sample_metadata <- sample_metadata_row %>% rownames_to_column("sample")

betadisper(beta_q1n, sample_metadata_row$group2) %>% permutest(., pairwise = TRUE) 

adonis2(beta_q1n ~ group2, 
        data = sample_metadata %>% arrange(match(sample,labels(beta_q1n))), 
        permutations = 999, by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r pairwise_neutral_wolves, comment="", message=FALSE, warning=FALSE}
pairwise.adonis(beta_q1n, sample_metadata$group2, perm = 999)
```

## Differential abundance
```{r chart1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
locationcolors=c('#c4d7d1','#408892','#c04062')

genome_counts_rel_fil<- genome_counts_filt %>% 
    select(one_of(c("genome",sample_metadata$sample))) %>% 
  column_to_rownames(., "genome")
  
genome_counts_rel_pa=1*(genome_counts_rel_fil>0)
#MAGrel_pa[1:6,1:6]
table_upset_analysis_cont=t(aggregate(t(genome_counts_rel_pa),by=list(sample_metadata$group2),FUN=sum)[,-1])
colnames(table_upset_analysis_cont)=levels(as.factor(sample_metadata$group2))
table_upset_analysis=(table_upset_analysis_cont>0)*1
table_upset_analysis=data.frame(table_upset_analysis)
table_upset_analysis=apply(table_upset_analysis,2,as.integer)
rownames(table_upset_analysis) <- rownames(genome_counts_rel_pa)

#pdf("figures/MAG_intersection.pdf",width=8,height=6, onefile=F)
upset(as.data.frame(table_upset_analysis),
  keep.order = T,
  sets = rev(c("Sled_dog","Dog","Wolf")),
  sets.bar.color= rev(locationcolors),
  mb.ratio = c(0.55, 0.45), order.by = "freq")
#dev.off()
```

```{r zero_phylo1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
phylo_samples <- sample_metadata %>%
  column_to_rownames("sample") %>%
  sample_data()
phylo_genome <- genome_counts_filt %>%
  select(one_of(c("genome", rownames(phylo_samples)))) %>%
  column_to_rownames("genome") %>%
  otu_table(., taxa_are_rows = TRUE)
phylo_taxonomy <- genome_metadata %>%
  filter(genome %in% rownames(phylo_genome)) %>%
  mutate(genome2 = genome) %>% 
  column_to_rownames("genome2") %>%
  dplyr::select(domain, phylum, class, order, family, genus, species, genome) %>% 
  as.matrix() %>%
  tax_table()

physeq_genome_filtered <- phyloseq(phylo_genome, phylo_taxonomy, phylo_samples)
```

```{r save_ancombc_summer, warning=FALSE, comments="", message=FALSE}
load("data/ancombc_results_groups.Rdata") #ancombc_results_wolves.Rdata
```

### MAG level
```{r ancom_rand_mag, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_mag = ancombc2(
  data = physeq_genome_filtered,
  assay_name = "counts",
  tax_level = NULL,
  fix_formula = "group2",
  p_adj_method = "holm",
  pseudo_sens = TRUE,
  prv_cut = 0,
  lib_cut = 0,
  s0_perc = 0.05,
  group = "group2",
  struc_zero = TRUE,
  neg_lb = FALSE,
  alpha = 0.05,
  n_cl = 2,
  verbose = TRUE,
  global = TRUE,
  pairwise = TRUE,
  dunnet = FALSE,
  trend = FALSE,
  iter_control = list(
    tol = 1e-5,
    max_iter = 20,
    verbose = FALSE
  ),
  em_control = list(tol = 1e-5, max_iter = 100),
  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100),
  trend_control = NULL
)
```

### the global differential taxa
```{r}
res_global <- ancom_rand_output_mag$res_global
global_hits <- res_global %>%
  filter(diff_abn == TRUE) %>%
  select(taxon, W, p_val, q_val)
```

### Extract the results
#### Structural zeros

***Total number of structural zeros***
```{r}
# Extract structural zeros
structural_zeros <- ancom_rand_output_mag$zero_ind

# Convert to a data frame for better readability
structural_zeros_df <- as.data.frame(structural_zeros) %>% 
  column_to_rownames(., "taxon")

structural_zero_taxa <- rownames(structural_zeros_df)[apply(structural_zeros_df, 1, any)]

# Identify in which groups each taxon is a structural zero
structural_zero_groups <- structural_zeros_df[structural_zero_taxa, , drop = FALSE] %>% 
  rename("Dog"=1) %>% 
  rename("Sled_dog"=2) %>% 
  rename("Wolf"=3) 

# Total number of structural zeros
nrow(structural_zero_groups)

```

***Structural zeros in dogs***
```{r}
structural_zero_groups %>% 
  filter(Dog==TRUE) %>% 
  nrow()
```

***Structural zeros in sled dogs***
```{r}
structural_zero_groups %>% 
  filter(Sled_dog==TRUE) %>% 
  nrow()
```

***Structural zeros in wolves***
```{r}
structural_zero_groups %>% 
  filter(Wolf==TRUE) %>% 
  nrow()

structural_zero_groups %>% 
  filter(Wolf==TRUE) %>% 
  rownames_to_column(., "genome") %>% 
  left_join(., genome_metadata, by="genome") %>% 
  count(phylum, name = "sample_count") %>%
  arrange(desc(sample_count)) 
```


```{r labeling, comment="", message=FALSE, warning=FALSE, fig.height=20, fig.width=10, fig.fullwidth=TRUE}
 res_pair <- ancom_rand_output_mag$res_pair

# Get log-fold change and q-value columns
lfc_cols <- grep("^lfc_", colnames(res_pair), value = TRUE)
q_cols   <- gsub("^lfc_", "q_", lfc_cols)

# Build long table by pairing lfc and q for each contrast
plot_data <- lfc_cols %>%
  setNames(nm = .) %>%
  purrr::imap_dfr(function(lfc_col, name) {
    q_col <- gsub("^lfc_", "q_", lfc_col)
    
    res_pair %>%
      select(taxon, !!lfc_col, !!q_col) %>%
      rename(
        lfc = !!lfc_col,
        q   = !!q_col
      ) %>%
      mutate(contrast_key = name)
  }) %>%
  filter(!is.na(lfc), !is.na(q), q < 0.05) %>%
  mutate(
    # Manually re-label contrasts for clarity
    contrast = case_when(
      contrast_key == "lfc_group2Sled_dog" ~ "Sled_dog vs Dog",
      contrast_key == "lfc_group2Wolf" ~ "Wolf vs Dog",
      contrast_key == "lfc_group2Wolf_group2Sled_dog" ~ "Wolf vs Sled_dog",
      TRUE ~ contrast_key
    ),
    direction = ifelse(lfc > 0, paste("Enriched in", sub(" vs.*", "", contrast)),
                             paste("Enriched in", sub(".*vs ", "", contrast)))
  )


```

```{r}
plot_data <- plot_data %>%
  left_join(genome_metadata %>% select(genome, phylum), by =join_by("taxon"=="genome"))

```

```{r}
# Loop through each contrast
unique_contrasts <- unique(plot_data$contrast)

taxonomy <- data.frame(physeq_genome_filtered@tax_table) %>%
  rownames_to_column(., "taxon")

colors_alphabetic <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
  mutate_at(vars(phylum), ~ str_replace(., "[dpcofgs]__", ""))  %>%
  right_join(taxonomy, by = join_by(phylum == phylum)) %>%
  dplyr::select(phylum, colors) %>%
  mutate(colors = str_c(colors, "80"))  %>% #add 80% alpha
  unique() %>%
  dplyr::arrange(phylum)

for (c in unique_contrasts) {
  locs <- str_split(c, " vs ", simplify = TRUE)
  title <- paste(locs[2], " - ", locs[1])#"Comparison:", 
  
  subset_data <- plot_data %>%
    filter(contrast == c) %>%
    arrange(direction, lfc) %>%
    mutate(taxon_ordered = factor(taxon, levels = unique(taxon)))
  
  tax_color <- as.data.frame(unique(subset_data$phylum)) %>%
    rename(phylum = 1) %>%
    left_join(., colors_alphabetic, by = "phylum") %>%
    dplyr::arrange(phylum) %>%
    dplyr::select(colors) %>%
    pull()
  
  p <- ggplot(subset_data, aes(x = taxon_ordered, y = lfc, fill = phylum)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    theme(
      panel.background = element_blank(),
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 6),
      axis.title = element_text(size = 14, face = "bold"),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 14, face = "bold"),
      legend.position = "right",
      legend.box = "vertical",
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5)
    ) +
    scale_fill_manual(values = tax_color) +
    labs(
      title = title,
      #paste("Enriched Taxa:", c)
      x = "Taxa",
      y = "Log-Fold Change",
      fill = "Phylum"
    )
  
  ggsave(paste0("Fig_", gsub(" ", "_", c), ".png"), plot = p, width = 10, height = 25, dpi = 300)
}
```
### Phylum level
```{r ancom_rand_phylum, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_phylum = ancombc2(
  data = physeq_genome_filtered,
  assay_name = "counts",
  tax_level = "phylum",
  fix_formula = "group2",
  p_adj_method = "holm",
  pseudo_sens = TRUE,
  prv_cut = 0,
  lib_cut = 0,
  s0_perc = 0.05,
  group = "group2",
  struc_zero = TRUE,
  neg_lb = FALSE,
  alpha = 0.05,
  n_cl = 2,
  verbose = TRUE,
  global = TRUE,
  pairwise = TRUE,
  dunnet = FALSE,
  trend = FALSE,
  iter_control = list(
    tol = 1e-5,
    max_iter = 20,
    verbose = FALSE
  ),
  em_control = list(tol = 1e-5, max_iter = 100),
  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100),
  trend_control = NULL
)
```

#### Structural zeros

***Total number of structural zeros***
```{r}
# Extract structural zeros
structural_zeros <- ancom_rand_output_phylum$zero_ind

# Convert to a data frame for better readability
structural_zeros_df <- as.data.frame(structural_zeros) %>% 
  column_to_rownames(., "taxon")

structural_zero_taxa <- rownames(structural_zeros_df)[apply(structural_zeros_df, 1, any)]

# Identify in which groups each taxon is a structural zero
structural_zero_groups <- structural_zeros_df[structural_zero_taxa, , drop = FALSE] %>% 
  rename("Dog"=1) %>% 
  rename("Sled_dog"=2) %>% 
  rename("Wolf"=3) 

# Total number of structural zeros
nrow(structural_zero_groups)

```

```{r  labeling_phylum, comment="", message=FALSE, warning=FALSE, fig.height=20, fig.width=10, fig.fullwidth=TRUE}
res_pair_phylum <- ancom_rand_output_phylum$res_pair
# Get log-fold change and q-value columns
lfc_cols <- grep("^lfc_", colnames(res_pair_phylum), value = TRUE)
q_cols   <- gsub("^lfc_", "q_", lfc_cols)

# Build long table by pairing lfc and q for each contrast
plot_data_phylum <- lfc_cols %>%
  setNames(nm = .) %>%
  purrr::imap_dfr(function(lfc_col, name) {
    q_col <- gsub("^lfc_", "q_", lfc_col)
    
    res_pair_phylum %>%
      select(taxon, !!lfc_col, !!q_col) %>%
      rename(
        lfc = !!lfc_col,
        q   = !!q_col
      ) %>%
      mutate(contrast_key = name)
  }) %>%
  filter(!is.na(lfc), !is.na(q), q < 0.05) %>%
  mutate(
    # Manually re-label contrasts for clarity
    contrast = case_when(
      contrast_key == "lfc_group2Sled_dog" ~ "Sled_dog vs Dog",
      contrast_key == "lfc_group2Wolf" ~ "Wolf vs Dog",
      contrast_key == "lfc_group2Wolf_group2Sled_dog" ~ "Wolf vs Sled_dog",
      TRUE ~ contrast_key
    ),
    direction = ifelse(lfc > 0, paste("Enriched in", sub(" vs.*", "", contrast)),
                             paste("Enriched in", sub(".*vs ", "", contrast)))
  )
plot_data_phylum
```

```{r}
# Loop through each contrast
unique_contrasts <- unique(plot_data_phylum$contrast)

taxonomy <- data.frame(physeq_genome_filtered@tax_table) %>%
  rownames_to_column(., "taxon")

colors_alphabetic <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
  mutate_at(vars(phylum), ~ str_replace(., "[dpcofgs]__", ""))  %>%
  right_join(taxonomy, by=join_by(phylum == phylum)) %>%
  dplyr::select(phylum, colors) %>%
  mutate(colors = str_c(colors, "80"))  %>% #add 80% alpha
	unique() %>%
	dplyr::arrange(phylum)


for (c in unique_contrasts) {
  
  locs <- str_split(c, " vs ", simplify = TRUE)
  title <- paste(locs[2], " - ", locs[1])# 

  
  subset_data_phylum <- plot_data_phylum %>%
    filter(contrast == c) %>%
    arrange(direction, lfc) %>%
    mutate(taxon_ordered = factor(taxon, levels = unique(taxon)))
  
  tax_color <- as.data.frame(unique(subset_data_phylum$taxon)) %>%
    rename(phylum = 1) %>%
    left_join(., colors_alphabetic, by = "phylum") %>%
    dplyr::arrange(phylum) %>%
    dplyr::select(colors) %>%
    pull()
  
  p <- ggplot(subset_data_phylum, aes(x = taxon_ordered, y = lfc, fill = taxon)) +
    geom_bar(stat = "identity", show.legend = FALSE) +
    coord_flip() +
    theme(
      panel.background = element_blank(),
      axis.line = element_line(
        size = 0.5,
        linetype = "solid",
        colour = "black"
      ),
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      axis.title = element_text(size = 14, face = "bold"),
      legend.text = element_blank(),
      legend.title = element_blank(),
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5)
    ) +
    scale_fill_manual(values = tax_color) +
    labs(
      title = title,
      x = "Taxa",
      y = "Log-Fold Change",
    )
  
  ggsave(paste0("Fig_phylum_", gsub(" ", "_", c), ".png"), plot = p, width = 6, height = 8, dpi = 300)
}
```

### Genus level
```{r ancom_rand_genus, comment="", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
ancom_rand_output_genus = ancombc2(
  data = physeq_genome_filtered,
  assay_name = "counts",
  tax_level = "genus",
  fix_formula = "group2",
  p_adj_method = "holm",
  pseudo_sens = TRUE,
  prv_cut = 0,
  lib_cut = 0,
  s0_perc = 0.05,
  group = "group2",
  struc_zero = TRUE,
  neg_lb = FALSE,
  alpha = 0.05,
  n_cl = 2,
  verbose = TRUE,
  global = TRUE,
  pairwise = TRUE,
  dunnet = FALSE,
  trend = FALSE,
  iter_control = list(
    tol = 1e-5,
    max_iter = 20,
    verbose = FALSE
  ),
  em_control = list(tol = 1e-5, max_iter = 100),
  mdfdr_control = list(fwer_ctrl_method = "holm", B = 100),
  trend_control = NULL
)
```

```{r save_ancombc, warning=FALSE, comments="", message=FALSE, eval=FALSE}
save(ancom_rand_output_mag,
     ancom_rand_output_phylum,
     ancom_rand_output_genus,
     file = "data/ancombc_results_groups.Rdata")
```

#### Structural zeros

***Total number of structural zeros***
```{r}
# Extract structural zeros
structural_zeros <- ancom_rand_output_genus$zero_ind

# Convert to a data frame for better readability
structural_zeros_df <- as.data.frame(structural_zeros) %>% 
  column_to_rownames(., "taxon")

structural_zero_taxa <- rownames(structural_zeros_df)[apply(structural_zeros_df, 1, any)]

# Identify in which groups each taxon is a structural zero
structural_zero_groups <- structural_zeros_df[structural_zero_taxa, , drop = FALSE] %>% 
  rename("Dog"=1) %>% 
  rename("Sled_dog"=2) %>% 
  rename("Wolf"=3) 

# Total number of structural zeros
nrow(structural_zero_groups)

```

***Structural zeros in autumn***
```{r}
structural_zero_groups %>% 
  filter(Dog==TRUE) %>% 
  nrow()
```

***Structural zeros in wolves***
```{r}
structural_zero_groups %>% 
  filter(Sled_dog==TRUE) %>% 
  nrow()
```

***Structural zeros in wolves***
```{r}
structural_zero_groups %>% 
  filter(Wolf==TRUE) %>% 
  nrow()

structural_zero_groups %>% 
  filter(Wolf==TRUE) %>% 
  rownames_to_column(., "genome") %>%
  mutate(taxon_clean = sub(".*:", "", genome)) %>% 
  left_join(., genome_metadata %>% select(genus, family, phylum) %>% distinct(), by =join_by("taxon_clean"=="genus"))%>% 
  left_join(., genome_metadata %>% select(family, phylum)%>% distinct(), by =join_by("taxon_clean"=="family")) %>%
  mutate(phylum.x = coalesce(phylum.x, phylum.y)) %>% 
  select(-family,-phylum.y) %>% 
  rename(phylum=phylum.x) %>% 
  count(phylum, name = "sample_count") %>%
  arrange(desc(sample_count)) 
```
```{r labeling_genus, comment="", message=FALSE, warning=FALSE, fig.height=20, fig.width=10, fig.fullwidth=TRUE}
res_pair_genus <- ancom_rand_output_genus$res_pair
# Get log-fold change and q-value columns
lfc_cols <- grep("^lfc_", colnames(res_pair_genus), value = TRUE)
q_cols   <- gsub("^lfc_", "q_", lfc_cols)

# Build long table by pairing lfc and q for each contrast
plot_data_genus <- lfc_cols %>%
  setNames(nm = .) %>%
  purrr::imap_dfr(function(lfc_col, name) {
    q_col <- gsub("^lfc_", "q_", lfc_col)
    
    res_pair_genus %>%
      select(taxon, !!lfc_col, !!q_col) %>%
      rename(
        lfc = !!lfc_col,
        q   = !!q_col
      ) %>%
      mutate(contrast_key = name)
  }) %>%
  filter(!is.na(lfc), !is.na(q), q < 0.05) %>%
  mutate(
    # Manually re-label contrasts for clarity
    contrast = case_when(
      contrast_key == "lfc_group2Sled_dog" ~ "Sled_dog vs Dog",
      contrast_key == "lfc_group2Wolf" ~ "Wolf vs Dog",
      contrast_key == "lfc_group2Wolf_group2Sled_dog" ~ "Wolf vs Sled_dog",
      TRUE ~ contrast_key
    ),
    direction = ifelse(lfc > 0, paste("Enriched in", sub(" vs.*", "", contrast)),
                             paste("Enriched in", sub(".*vs ", "", contrast)))
  )


```

```{r}
plot_data_genus <- plot_data_genus %>%
  mutate(taxon_clean = sub(".*:", "", taxon)) %>% 
  left_join(., genome_metadata %>% select(genus, family, phylum) %>% distinct(), by =join_by("taxon_clean"=="genus"))%>% 
  left_join(., genome_metadata %>% select(family, phylum)%>% distinct(), by =join_by("taxon_clean"=="family")) %>%
  mutate(phylum.x = coalesce(phylum.x, phylum.y)) %>% 
  select(-family,-phylum.y) %>% 
  rename(phylum=phylum.x)

```

```{r}
# Loop through each contrast
unique_contrasts <- unique(plot_data_genus$contrast)

taxonomy <- data.frame(physeq_genome_filtered@tax_table) %>%
  rownames_to_column(., "taxon")

colors_alphabetic <- read_tsv("https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv") %>%
  mutate_at(vars(phylum), ~ str_replace(., "[dpcofgs]__", ""))  %>%
  right_join(taxonomy, by=join_by(phylum == phylum)) %>%
  dplyr::select(phylum, colors) %>%
  mutate(colors = str_c(colors, "80"))  %>% #add 80% alpha
	unique() %>%
	dplyr::arrange(phylum)

for (c in unique_contrasts) {
  locs <- str_split(c, " vs ", simplify = TRUE)
  titulu <- paste(locs[2], " - ", locs[1])
  
  subset_data_genus <- plot_data_genus %>%
    filter(contrast == c) %>%
    arrange(direction, lfc) 
#  %>%  mutate(taxon_ordered = factor(taxon_clean, levels = unique(taxon_clean)))
  
  tax_color <- as.data.frame(unique(subset_data_genus$phylum)) %>% 
    rename(phylum=1) %>% 
    left_join(., colors_alphabetic, by="phylum")%>%
    dplyr::arrange(phylum) %>%
    dplyr::select(colors) %>%
    pull()

  
  p <- ggplot(subset_data_genus, aes(x=lfc, y=forcats::fct_reorder(taxon_clean,lfc), fill=phylum))  +
    geom_bar(stat = "identity") +
 #   coord_flip() +
  theme(panel.background = element_blank(),
        axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 6),
        axis.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, face = "bold"),
        legend.position = "right", legend.box = "vertical",
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5))+   
      scale_fill_manual(values=tax_color) + 
    labs(
      title = titulu,
      x = "Taxa",
      y = "Log-Fold Change",
      fill = "Direction"
    )
  
  ggsave(paste0("Fig_genus_", gsub(" ", "_", c), ".png"), plot = p, width = 6, height = 10, dpi = 300)
}
```

## Functional differences
## Groups MCI
```{r gitfs_functional_wild, echo=TRUE,results=TRUE}
GIFTs_functions_community %>%
  rowMeans() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
  group_by(group2) %>%
  summarise(MCI = mean(value), sd = sd(value)) %>%
  tt()
```
```{r gitfs_functional_wild, echo=TRUE,results=TRUE}
GIFTs_functions_community %>%
  rowMeans() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
  group_by(group1) %>%
  summarise(MCI = mean(value), sd = sd(value)) %>%
  tt()
```

```{r}
MCI <- GIFTs_functions_community %>%
  rowMeans() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) 

shapiro.test(MCI$value)
kruskal.test(value ~ group2, data=MCI)
```

## Community elements differences:

```{r commun_wilcox_elem_summer, comment="", echo=FALSE, message=FALSE, warning=FALSE}

element_gift <- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  left_join(sample_metadata[c(1,7)], by="sample")

uniqueGIFT_db<- unique(GIFT_db[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements <- element_gift %>%
    pivot_longer(-c(sample,locality), names_to = "trait", values_to = "value") %>%
    group_by(trait) %>%
  summarise(p_value = kruskal.test(value ~ locality)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
    filter(p_adjust < 0.05)%>%
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)

selected_data <- element_gift %>%
  pivot_longer(-c(sample, locality), names_to = "trait", values_to = "value") %>%
  filter(trait %in% significant_elements$trait)

# Now run Dunn's test per trait
library(rstatix)

pairwise_results <- selected_data %>%
  group_by(trait) %>%
  dunn_test(value ~ locality, p.adjust.method = "BH")%>% 
  filter(p.adj<0.05) %>%
  mutate(comparison = paste(group1, "vs", group2)) %>% 
  left_join(., uniqueGIFT_db, by=join_by(trait==Code_element)) %>%
  filter(!comparison %in% c("Mongolia vs South Africa", "Mongolia vs USA", "Laos vs Mongolia", "India vs Mongolia", "South Africa vs USA","Laos vs South Africa", "Laos vs India", "India vs South Africa", "India vs USA", "Laos vs USA"))

```

```{r function_plot_summer, comment="", message=FALSE, warning=FALSE, fig.height=20, fig.width=10, fig.fullwidth=TRUE}
ggplot(pairwise_results, aes(x = comparison, y = fct_rev(Function))) +
  geom_tile(aes(fill = p.adj), color = "white") +
  geom_text(aes(label = p.adj.signif), size = 4, color = "black") +
  scale_fill_gradient(low = "#b30000", high = "#fef0d9" , name = "Adjusted p-value") +
  theme_minimal() +
  labs(
    title = "Significant Pairwise Comparisons by Trait",
    x = "Locality Comparison",
    y = "Trait"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )
```
```{r barplot_func_wolves, comment="", message=FALSE, warning=FALSE, fig.height=60, fig.width=30, fig.fullwidth=TRUE}
# Filter and reshape data for significant traits
element_gift <- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  left_join(sample_metadata[c(1,5,7)], by="sample")

plot_data <- element_gift %>%
  pivot_longer(-c(sample, locality, origin), names_to = "trait", values_to = "value") %>%
  filter(trait %in% pairwise_results$trait)%>% 
  left_join(., uniqueGIFT_db, by=join_by(trait==Code_element)) 
# %>% 
#   filter(Function=="Xenobiotic degradation_Mercury")

# Plot boxplots per trait
ggplot(plot_data, aes(x = locality, y = value, fill = locality)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
    geom_jitter(aes(shape = origin), width = 0.2, size = 3) +
  #geom_jitter(width = 0.2, size = 1, alpha = 0.4) +
  facet_wrap(~ Function, scales = "free_y", ncol = 4) +
  theme_minimal(base_size = 16) +
  labs(
    title = "Trait Distributions Across Localities",
    x = "Locality",
    y = "Trait Value" )
```

### by group

```{r commun_wilcox_elem_summer, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift <- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  left_join(sample_metadata[c(1,13)], by="sample")

uniqueGIFT_db<- unique(GIFT_db[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements <- element_gift %>%
    pivot_longer(-c(sample,group2), names_to = "trait", values_to = "value") %>%
    group_by(trait) %>%
  summarise(p_value = kruskal.test(value ~ group2)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
    filter(p_adjust < 0.05)%>%
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)

selected_data <- element_gift %>%
  pivot_longer(-c(sample, group2), names_to = "trait", values_to = "value") %>%
  filter(trait %in% significant_elements$trait)

# Run Dunn's test per trait
pairwise_results <- selected_data %>%
  group_by(trait) %>%
  dunn_test(value ~ group2, p.adjust.method = "BH")%>% 
  filter(p.adj<0.05) %>%
  mutate(comparison = paste(group1, "vs", group2)) %>% 
  left_join(., uniqueGIFT_db, by=join_by(trait==Code_element))
```
```{r}
pairwise_results %>% group_by(comparison) %>%
  summarise(num_significant_functions = n()) %>% 
  arrange(num_significant_functions)
```
```{r function_plot_summer, comment="", message=FALSE, warning=FALSE, fig.height=20, fig.width=10, fig.fullwidth=TRUE}
ggplot(pairwise_results, aes(x = comparison, y = fct_rev(Function))) +
  geom_tile(aes(fill = p.adj), color = "white") +
  geom_text(aes(label = p.adj.signif), size = 4, color = "black") +
  scale_fill_gradient(low = "#b30000", high = "#fef0d9" , name = "Adjusted p-value") +
  theme_minimal() +
  labs(
    title = "Significant Pairwise Comparisons by Trait",
    x = "Groups",
    y = "Trait"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )
```

```{r barplot_func_wolves, comment="", message=FALSE, warning=FALSE, fig.height=60, fig.width=30, fig.fullwidth=TRUE}
# Filter and reshape data for significant traits
element_gift <- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  left_join(sample_metadata[c(1,13)], by="sample")

plot_data <- element_gift %>%
  pivot_longer(-c(sample, group2), names_to = "trait", values_to = "value") %>%
  filter(trait %in% pairwise_results$trait)%>% 
  left_join(., uniqueGIFT_db, by=join_by(trait==Code_element)) 
# %>% 
#   filter(Function=="Xenobiotic degradation_Mercury")

# Plot boxplots per trait
ggplot(plot_data, aes(x = group2, y = value, fill = group2)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.4) +
  facet_wrap(~ Function, scales = "free_y", ncol = 4) +
  theme_minimal(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(
    title = "Trait Distributions Across Groups",
    x = "group",
    y = "Trait Value" )
```
```{r}
plot_data %>% group_by(group1, Function) %>% summarise(mean=mean(value)) %>% pivot_wider(names_from = group1, values_from = c(mean))
```


```{r}
pairwise_results %>% filter(comparison=="Dog vs Sled_dog_civilian_summer") %>% select(Function) %>% pull()
```

```{r barplot_func_wolves, comment="", message=FALSE, warning=FALSE, fig.height=60, fig.width=30, fig.fullwidth=TRUE}
# Filter and reshape data for significant traits
element_gift <- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  left_join(sample_metadata[c(1,5,12)], by="sample")%>% 
   filter(group1%in% c("Dog", "Sled_dog_civilian_summer"))

pairwise_dog_sled <- pairwise_results %>% filter(comparison=="Dog vs Sled_dog_civilian_summer")

plot_data <- element_gift %>%
  pivot_longer(-c(sample, group1, origin), names_to = "trait", values_to = "value") %>%
  filter(trait %in% pairwise_dog_sled$trait)%>% 
  left_join(., uniqueGIFT_db, by=join_by(trait==Code_element)) 
# %>% 
#   filter(Function=="Xenobiotic degradation_Mercury")

# Plot boxplots per trait
ggplot(plot_data, aes(x = group1, y = value, fill = group1)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
    geom_jitter(aes(shape = origin), width = 0.2, size = 3) +
  #geom_jitter(width = 0.2, size = 1, alpha = 0.4) +
  facet_wrap(~ Function, scales = "free_y", ncol = 4) +
  theme_minimal(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(
    title = "Trait Distributions Across Groups",
    x = "group",
    y = "Trait Value" )
```


## Community function differences:
```{r commun_wilcox_func_summer, comment="", echo=FALSE, message=FALSE, warning=FALSE}
function_gift <- GIFTs_functions_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  left_join(sample_metadata[c(1,13)], by="sample")

uniqueFuncGIFT_db<- unique(GIFT_db[c(3,4,5)])

significant_functions <- function_gift %>%
    pivot_longer(-c(sample,group2), names_to = "trait", values_to = "value") %>%
    group_by(trait) %>%
  summarise(p_value = kruskal.test(value ~ group2)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
    filter(p_adjust < 0.05)%>%
  rownames_to_column(., "functions")  %>% 
  select(-functions)

selected_data <- function_gift %>%
  pivot_longer(-c(sample, group2), names_to = "trait", values_to = "value") %>%
  filter(trait %in% significant_functions$trait)

# Now run Dunn's test per trait
library(rstatix)

pairwise_results_func <- selected_data %>%
  group_by(trait) %>%
  dunn_test(value ~ group2, p.adjust.method = "BH")%>% 
  filter(p.adj<0.05) %>%
  mutate(comparison = paste(group1, "vs", group2)) %>% 
  left_join(., uniqueFuncGIFT_db, by=join_by(trait==Code_function))

```

```{r pairwise_plot_func, comment="", message=FALSE, warning=FALSE, fig.height=10, fig.width=10, fig.fullwidth=TRUE}
ggplot(pairwise_results_func, aes(x = comparison, y = fct_rev(Function))) +
  geom_tile(aes(fill = p.adj), color = "white") +
  geom_text(aes(label = p.adj.signif), size = 4, color = "black") +
  scale_fill_gradient(low = "#b30000", high = "#fef0d9" , name = "Adjusted p-value") +
  theme_minimal() +
  labs(
    title = "Significant Pairwise Comparisons by Trait",
    x = "Locality Comparison",
    y = "Trait"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )

```

```{r barplot_func_wolves, comment="", message=FALSE, warning=FALSE, fig.height=20, fig.width=30, fig.fullwidth=TRUE}
# Filter and reshape data for significant traits
function_gift <- GIFTs_functions_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "sample") %>% 
  left_join(sample_metadata[c(1,13)], by="sample")

plot_data <- function_gift %>%
  pivot_longer(-c(sample, group2), names_to = "trait", values_to = "value") %>%
  filter(trait %in% pairwise_results_func$trait)%>% 
  left_join(., uniqueFuncGIFT_db, by=join_by(trait==Code_function)) 
# %>% 
#   filter(Function=="Xenobiotic degradation_Mercury")

# Plot boxplots per trait
ggplot(plot_data, aes(x = group2, y = value, fill = group2)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.2, size = 1, alpha = 0.4) +
  facet_wrap(~ Function, scales = "free_y", ncol = 4) +
  theme_minimal(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(
    title = "Trait Distributions Across Localities",
    x = "Locality",
    y = "Trait Value" )
```

