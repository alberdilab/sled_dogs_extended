[["greenlandic-sled-dogs-in-summer.html", "Chapter 9 Greenlandic sled dogs in summer 9.1 Filter data 9.2 Taxonomy overview 9.3 Enrichment analysis: Ancombc2", " Chapter 9 Greenlandic sled dogs in summer 9.1 Filter data load(&quot;data/data.Rdata&quot;) sample_metadata &lt;- read_csv(&quot;data/sample_metadata.csv&quot;) sample_metadata &lt;- sample_metadata %&gt;% filter(country== &quot;Greenland&quot;) # sample_metadata &lt;- sample_metadata %&gt;% # filter(country== &quot;Greenland&quot; | breed == &quot;Wolf&quot;) sample_metadata$individual &lt;- sub(&quot;[0-9]{2}$&quot;, &quot;&quot;, sample_metadata$animal) sample_metadata_illu &lt;- read_csv(&quot;data/metadata_illu.csv&quot;) sample_metadata &lt;- sample_metadata %&gt;% left_join(sample_metadata_illu[c(1,4,9)], by=join_by(&quot;sample&quot;==&quot;DogID&quot;)) %&gt;% filter(!Samples %in% c(&quot;Blank&quot;,&quot;Saliva&quot;)) %&gt;% filter(individual!=&quot;GL_02_&quot;) %&gt;% filter(season!=&quot;winter&quot;) genome_counts_filt &lt;- genome_counts_filt %&gt;% select(one_of(c(&quot;genome&quot;,sample_metadata$sample)))%&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) genome_metadata &lt;- genome_metadata %&gt;% semi_join(., genome_counts_filt, by = &quot;genome&quot;) %&gt;% arrange(match(genome,genome_counts_filt$genome)) genome_tree &lt;- keep.tip(genome_tree, tip=genome_metadata$genome) # keep only MAG tips 9.2 Taxonomy overview Number of bacteria phyla [1] 16 After merging all Bacillota genome_metadata &lt;- genome_metadata %&gt;% mutate(phylum_clean = ifelse(grepl(&quot;^Bacillota_&quot;, phylum), &quot;Bacillota&quot;, phylum)) genome_metadata %&gt;% filter(domain == &quot;Bacteria&quot;)%&gt;% dplyr::select(phylum_clean) %&gt;% unique() %&gt;% pull() %&gt;% length() ## [1] 12 9.2.1 Stacked barplot genome_counts_filt %&gt;% mutate_at(vars(-genome), ~ . / sum(.)) %&gt;% pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% left_join(., genome_metadata, by = join_by(genome == genome)) %&gt;% left_join(., sample_metadata, by = join_by(sample == sample)) %&gt;% filter(count &gt; 0) %&gt;% ggplot(., aes(x = sample, y = count, fill = phylum, group = phylum )) + geom_bar(stat = &quot;identity&quot;, colour = &quot;white&quot;, linewidth = 0.1) + scale_fill_manual(values = phylum_colors) + facet_grid( ~ locality, scale = &quot;free&quot;, space = &quot;free&quot;) + guides(fill = guide_legend(ncol = 1)) + theme( axis.title.x = element_blank(), panel.background = element_blank(), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_rect(fill = &quot;white&quot;), strip.text = element_text(size = 8, lineheight = 0.6), strip.placement = &quot;outside&quot;, axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.line = element_line( linewidth = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot; ) ) + labs(fill = &quot;Phylum&quot;, y = &quot;Relative abundance&quot;, x = &quot;Samples&quot;) 9.2.2 Phylum relative abundances phylum_summary &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS nornalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% group_by(sample,phylum_clean,locality) %&gt;% summarise(relabun=sum(count)) phylum_arrange &lt;- phylum_summary %&gt;% group_by(phylum_clean) %&gt;% summarise(mean=mean(relabun)) %&gt;% arrange(-mean) %&gt;% select(phylum_clean) %&gt;% pull() phylum_summary %&gt;% group_by(phylum_clean) %&gt;% summarise( total_mean = mean(relabun * 100, na.rm = T), total_sd = sd(relabun * 100, na.rm = T), Daneborg_mean = mean(relabun[locality == &quot;Daneborg&quot;] * 100, na.rm =T), Daneborg_sd = sd(relabun[locality == &quot;Daneborg&quot;] * 100, na.rm =T), Disko_mean = mean(relabun[locality == &quot;Disko&quot;] * 100, na.rm = T), Disko_sd = sd(relabun[locality == &quot;Disko&quot;] * 100, na.rm =T), Illulissat_mean = mean(relabun[locality == &quot;Illulissat&quot;] * 100, na.rm = T), Illulissat_sd = sd(relabun[locality == &quot;Illulissat&quot;] * 100, na.rm = T), Ittoqqortoormiit_mean = mean(relabun[locality == &quot;Ittoqqortoormiit&quot;] * 100, na.rm = T), Ittoqqortoormiit_sd = sd(relabun[locality == &quot;Ittoqqortoormiit&quot;] * 100, na.rm = T), Wolf_mean = mean(relabun[locality == &quot;Mongolia&quot;] * 100, na.rm = T), Wolf_sd = sd(relabun[locality == &quot;Mongolia&quot;] * 100, na.rm = T)) %&gt;% mutate( total = str_c(round(total_mean, 4), &quot;±&quot;, round(total_sd, 3)), Daneborg = str_c(round(Daneborg_mean, 4), &quot;±&quot;, round(Daneborg_sd, 3)), Disko = str_c(round(Disko_mean, 4), &quot;±&quot;, round(Disko_sd, 3)), Illulissat = str_c(round(Illulissat_mean, 4), &quot;±&quot;, round(Illulissat_sd, 3)), Ittoqqortoormiit = str_c(round(Ittoqqortoormiit_mean, 4), &quot;±&quot;, round(Ittoqqortoormiit_sd, 3)), Wolf = str_c(round(Wolf_mean, 4), &quot;±&quot;, round(Wolf_sd, 3)) ) %&gt;% arrange(-total_mean) %&gt;% dplyr::select(phylum_clean, total, Daneborg, Disko,Illulissat,Ittoqqortoormiit, Wolf) ## # A tibble: 12 × 7 ## phylum_clean total Daneborg Disko Illulissat Ittoqqortoormiit Wolf ## &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; ## 1 Bacteroidota 35.9871±1… 41.5161… 36.2… 34.7868±1… 30.9737±12.256 &lt;NA&gt; ## 2 Bacillota 28.3433±1… 17.3291… 33.9… 31.5784±1… 28.4885±11.966 &lt;NA&gt; ## 3 Fusobacteriota 22.4994±1… 28.6227… 17.1… 21.2002±8… 25.4034±13.712 &lt;NA&gt; ## 4 Pseudomonadota 9.6042±6.… 10.5417… 7.59… 8.8876±4.… 12.2208±10.585 &lt;NA&gt; ## 5 Actinomycetota 2.0261±2.… 0.6224±… 3.48… 2.428±1.5… 0.9458±0.684 &lt;NA&gt; ## 6 Campylobacterota 0.9357±1.… 0.6724±… 0.97… 0.5842±0.… 1.425±1.394 &lt;NA&gt; ## 7 Deferribacterota 0.3659±0.… 0.4707±… 0.36… 0.2218±0.… 0.3788±0.687 &lt;NA&gt; ## 8 Cyanobacteriota 0.1112±0.… 0.0254±… 0.15… 0.2234±0.… 0.0367±0.021 &lt;NA&gt; ## 9 Spirochaetota 0.0981±0.… 0.1124±… 0.07… 0.0803±0.… 0.1257±0.3 &lt;NA&gt; ## 10 Desulfobacterota 0.0289±0.… 0.0871±… 0.01… 0.009±0.0… 0.0013±0.003 &lt;NA&gt; ## 11 Fibrobacterota 2e-04±0 0±0 2e-0… 2e-04±0 1e-04±0 &lt;NA&gt; ## 12 Verrucomicrobiota 0±0 0±0 0±0 0±0 0±0 &lt;NA&gt; # Calculate Hill numbers richness &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 0) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(richness = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) neutral &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(neutral = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) phylogenetic &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1, tree = genome_tree) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(phylogenetic = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) genome_counts_filt_beta &lt;- genome_counts_filt[genome_counts_filt$genome %in% rownames(genome_gifts),] genome_counts_filt_beta &lt;- genome_counts_filt_beta %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0))%&gt;% rownames_to_column(., &quot;genome&quot;) genome_gifts1 &lt;- genome_gifts[rownames(genome_gifts) %in% genome_counts_filt_beta$genome,] genome_gifts1 &lt;- genome_gifts1[, colSums(genome_gifts1 != 0) &gt; 0] dist &lt;- genome_gifts1 %&gt;% to.elements(., GIFT_db) %&gt;% traits2dist(., method = &quot;gower&quot;) functional &lt;- genome_counts_filt %&gt;% filter(genome %in% rownames(dist)) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1, dist = dist) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(functional = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) %&gt;% mutate(functional = if_else(is.nan(functional), 1, functional)) # Merge all metrics alpha_div &lt;- richness %&gt;% full_join(neutral, by = join_by(sample == sample)) %&gt;% full_join(phylogenetic, by = join_by(sample == sample))%&gt;% full_join(functional, by = join_by(sample == sample)) 9.2.3 Plots 9.2.4 Values alpha_div %&gt;% pivot_longer(-sample, names_to = &quot;alpha&quot;, values_to = &quot;value&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% group_by(alpha) %&gt;% summarise( total_mean = mean(value, na.rm = T), total_sd = sd(value, na.rm = T), Daneborg_mean = mean(value[locality == &quot;Daneborg&quot;], na.rm =T), Daneborg_sd = sd(value[locality == &quot;Daneborg&quot;], na.rm =T), Disko_mean = mean(value[locality == &quot;Disko&quot;], na.rm = T), Disko_sd = sd(value[locality == &quot;Disko&quot;], na.rm =T), Illulissat_mean = mean(value[locality == &quot;Illulissat&quot;], na.rm = T), Illulissat_sd = sd(value[locality == &quot;Illulissat&quot;], na.rm = T), Ittoqqortoormiit_mean = mean(value[locality == &quot;Ittoqqortoormiit&quot;], na.rm = T), Ittoqqortoormiit_sd = sd(value[locality == &quot;Ittoqqortoormiit&quot;], na.rm = T),, Wolf_mean = mean(value[locality == &quot;Mongolia&quot;], na.rm = T), Wolf_sd = sd(value[locality == &quot;Mongolia&quot;], na.rm = T)) %&gt;% mutate( total = str_c(round(total_mean, 3), &quot;±&quot;, round(total_sd, 3)), Daneborg = str_c(round(Daneborg_mean, 3), &quot;±&quot;, round(Daneborg_sd, 3)), Disko = str_c(round(Disko_mean, 3), &quot;±&quot;, round(Disko_sd, 3)), Illulissat = str_c(round(Illulissat_mean, 3), &quot;±&quot;, round(Illulissat_sd, 3)), Ittoqqortoormiit = str_c(round(Ittoqqortoormiit_mean, 3), &quot;±&quot;, round(Ittoqqortoormiit_sd, 3)), Wolf = str_c(round(Wolf_mean, 3), &quot;±&quot;, round(Wolf_sd, 3)) ) %&gt;% arrange(-total_mean) %&gt;% dplyr::select(alpha,total, Daneborg, Disko,Illulissat,Ittoqqortoormiit, Wolf) # A tibble: 4 × 7 alpha total Daneborg Disko Illulissat Ittoqqortoormiit Wolf &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 richness 1178.71±53.318 1115.138±… 1224… 1216.391±… 1144.345±30.441 &lt;NA&gt; 2 neutral 144.575±43.541 114.756±2… 164.… 170.644±3… 124.141±42.755 &lt;NA&gt; 3 phylogenetic 7.677±1.258 6.697±0.8… 8.24… 8.261±0.9… 7.357±1.065 &lt;NA&gt; 4 functional 1.476±0.047 1.443±0.0… 1.49… 1.481±0.0… 1.486±0.053 &lt;NA&gt; 9.2.5 Mixed models Analysis of Deviance Table Model: Negative Binomial(39379537), link: log Response: richness Terms added sequentially (first to last) Df Deviance Resid. Df Resid. Dev Pr(&gt;Chi) NULL 123 299.518 locality 3 233.88 120 65.638 &lt; 2.2e-16 *** --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Call: MASS::glm.nb(formula = richness ~ locality, data = alpha_div_meta, trace = TRUE, init.theta = 39379536.8, link = log) Coefficients: Estimate Std. Error z value Pr(&gt;|z|) (Intercept) 7.016733 0.005561 1261.805 &lt; 2e-16 *** localityDisko 0.093640 0.007065 13.254 &lt; 2e-16 *** localityIllulissat 0.086910 0.008165 10.644 &lt; 2e-16 *** localityIttoqqortoormiit 0.025854 0.007814 3.309 0.000937 *** --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 (Dispersion parameter for Negative Binomial(39379537) family taken to be 1) Null deviance: 299.518 on 123 degrees of freedom Residual deviance: 65.638 on 120 degrees of freedom AIC: 1180.4 Number of Fisher Scoring iterations: 1 Theta: 39379537 Std. Err.: 503994211 Warning while fitting theta: iteration limit reached 2 x log-likelihood: -1170.377 $emmeans locality emmean SE df asymp.LCL asymp.UCL Daneborg 7.017 0.00556 Inf 7.006 7.028 Disko 7.110 0.00436 Inf 7.102 7.119 Illulissat 7.104 0.00598 Inf 7.092 7.115 Ittoqqortoormiit 7.043 0.00549 Inf 7.032 7.053 Results are given on the log (not the response) scale. Confidence level used: 0.95 $contrasts contrast estimate SE df z.ratio p.value Daneborg - Disko -0.09364 0.00707 Inf -13.254 &lt;.0001 Daneborg - Illulissat -0.08691 0.00817 Inf -10.644 &lt;.0001 Daneborg - Ittoqqortoormiit -0.02585 0.00781 Inf -3.309 0.0052 Disko - Illulissat 0.00673 0.00740 Inf 0.910 0.7997 Disko - Ittoqqortoormiit 0.06779 0.00701 Inf 9.671 &lt;.0001 Illulissat - Ittoqqortoormiit 0.06106 0.00812 Inf 7.522 &lt;.0001 Results are given on the log (not the response) scale. P value adjustment: tukey method for comparing a family of 4 estimates Analysis of Variance Table Response: neutral Df Sum Sq Mean Sq F value Pr(&gt;F) locality 3 70637 23545.8 17.383 1.948e-09 *** Residuals 120 162545 1354.5 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Call: lm(formula = neutral ~ locality, data = alpha_div_meta) Residuals: Min 1Q Median 3Q Max -86.121 -25.760 0.704 28.304 107.054 Coefficients: Estimate Std. Error t value Pr(&gt;|t|) (Intercept) 114.756 6.834 16.791 &lt; 2e-16 *** localityDisko 49.768 8.844 5.628 1.22e-07 *** localityIllulissat 55.888 10.276 5.439 2.88e-07 *** localityIttoqqortoormiit 9.385 9.665 0.971 0.333 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Residual standard error: 36.8 on 120 degrees of freedom Multiple R-squared: 0.3029, Adjusted R-squared: 0.2855 F-statistic: 17.38 on 3 and 120 DF, p-value: 1.948e-09 $emmeans locality emmean SE df lower.CL upper.CL Daneborg 115 6.83 120 101 128 Disko 165 5.61 120 153 176 Illulissat 171 7.67 120 155 186 Ittoqqortoormiit 124 6.83 120 111 138 Confidence level used: 0.95 $contrasts contrast estimate SE df t.ratio p.value Daneborg - Disko -49.77 8.84 120 -5.628 &lt;.0001 Daneborg - Illulissat -55.89 10.30 120 -5.439 &lt;.0001 Daneborg - Ittoqqortoormiit -9.39 9.67 120 -0.971 0.7662 Disko - Illulissat -6.12 9.51 120 -0.644 0.9175 Disko - Ittoqqortoormiit 40.38 8.84 120 4.566 0.0001 Illulissat - Ittoqqortoormiit 46.50 10.30 120 4.525 0.0001 P value adjustment: tukey method for comparing a family of 4 estimates Analysis of Variance Table Response: phylogenetic Df Sum Sq Mean Sq F value Pr(&gt;F) locality 3 52.296 17.4318 14.7 3.257e-08 *** Residuals 120 142.305 1.1859 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Call: lm(formula = phylogenetic ~ locality, data = alpha_div_meta) Residuals: Min 1Q Median 3Q Max -3.1823 -0.6443 0.0360 0.5909 4.0160 Coefficients: Estimate Std. Error t value Pr(&gt;|t|) (Intercept) 6.6971 0.2022 33.118 &lt; 2e-16 *** localityDisko 1.5432 0.2617 5.898 3.48e-08 *** localityIllulissat 1.5638 0.3041 5.143 1.06e-06 *** localityIttoqqortoormiit 0.6602 0.2860 2.309 0.0227 * --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Residual standard error: 1.089 on 120 degrees of freedom Multiple R-squared: 0.2687, Adjusted R-squared: 0.2505 F-statistic: 14.7 on 3 and 120 DF, p-value: 3.257e-08 $emmeans locality emmean SE df lower.CL upper.CL Daneborg 6.70 0.202 120 6.30 7.10 Disko 8.24 0.166 120 7.91 8.57 Illulissat 8.26 0.227 120 7.81 8.71 Ittoqqortoormiit 7.36 0.202 120 6.96 7.76 Confidence level used: 0.95 $contrasts contrast estimate SE df t.ratio p.value Daneborg - Disko -1.5432 0.262 120 -5.898 &lt;.0001 Daneborg - Illulissat -1.5638 0.304 120 -5.143 &lt;.0001 Daneborg - Ittoqqortoormiit -0.6602 0.286 120 -2.309 0.1017 Disko - Illulissat -0.0206 0.281 120 -0.073 0.9999 Disko - Ittoqqortoormiit 0.8830 0.262 120 3.374 0.0054 Illulissat - Ittoqqortoormiit 0.9036 0.304 120 2.972 0.0185 P value adjustment: tukey method for comparing a family of 4 estimates Analysis of Variance Table Response: functional Df Sum Sq Mean Sq F value Pr(&gt;F) locality 3 0.043216 0.0144053 7.5394 0.0001155 *** Residuals 120 0.229282 0.0019107 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Call: lm(formula = functional ~ locality, data = alpha_div_meta) Residuals: Min 1Q Median 3Q Max -0.128325 -0.022949 -0.003123 0.018900 0.163235 Coefficients: Estimate Std. Error t value Pr(&gt;|t|) (Intercept) 1.442942 0.008117 177.768 &lt; 2e-16 *** localityDisko 0.046653 0.010503 4.442 2e-05 *** localityIllulissat 0.037742 0.012205 3.092 0.002470 ** localityIttoqqortoormiit 0.043363 0.011479 3.778 0.000248 *** --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Residual standard error: 0.04371 on 120 degrees of freedom Multiple R-squared: 0.1586, Adjusted R-squared: 0.1376 F-statistic: 7.539 on 3 and 120 DF, p-value: 0.0001155 $emmeans locality emmean SE df lower.CL upper.CL Daneborg 1.44 0.00812 120 1.43 1.46 Disko 1.49 0.00667 120 1.48 1.50 Illulissat 1.48 0.00911 120 1.46 1.50 Ittoqqortoormiit 1.49 0.00812 120 1.47 1.50 Confidence level used: 0.95 $contrasts contrast estimate SE df t.ratio p.value Daneborg - Disko -0.04665 0.0105 120 -4.442 0.0001 Daneborg - Illulissat -0.03774 0.0122 120 -3.092 0.0130 Daneborg - Ittoqqortoormiit -0.04336 0.0115 120 -3.778 0.0014 Disko - Illulissat 0.00891 0.0113 120 0.789 0.8592 Disko - Ittoqqortoormiit 0.00329 0.0105 120 0.313 0.9893 Illulissat - Ittoqqortoormiit -0.00562 0.0122 120 -0.461 0.9674 P value adjustment: tukey method for comparing a family of 4 estimates beta_q0n &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) %&gt;% hillpair(., q = 0) beta_q1n &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) %&gt;% hillpair(., q = 1) genome_counts &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0))%&gt;% rownames_to_column(., &quot;genome&quot;) genome_tree &lt;- keep.tip(genome_tree, tip=genome_counts_filt$genome) beta_q1p &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) %&gt;% hillpair(., q = 1, tree = genome_tree) genome_counts_filt_beta &lt;- genome_counts_filt[genome_counts_filt$genome %in% rownames(genome_gifts),] genome_counts_filt_beta &lt;- genome_counts_filt_beta %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0))%&gt;% rownames_to_column(., &quot;genome&quot;) genome_gifts1 &lt;- genome_gifts[rownames(genome_gifts) %in% genome_counts_filt_beta$genome,] genome_gifts1 &lt;- genome_gifts1[, colSums(genome_gifts1 != 0) &gt; 0] dist &lt;- genome_gifts1 %&gt;% to.elements(., GIFT_db) %&gt;% traits2dist(., method = &quot;gower&quot;) beta_q1f &lt;- genome_counts_filt_beta %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) %&gt;% hillpair(., q = 1, dist = dist) 9.2.6 Beta diversity plots load(&quot;data/beta_greenland_summer.Rdata&quot;) 9.2.6.1 Richness beta_q0n$S %&gt;% vegan::metaMDS(., trymax = 500, k = 2, trace=0) %&gt;% vegan::scores() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% group_by(locality) %&gt;% mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %&gt;% mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% ggplot(aes(x = NMDS1, y = NMDS2, color = locality)) + geom_point(size = 4) + geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9, show.legend = FALSE) + theme_classic() + theme( axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), axis.title = element_text(size = 12, face = &quot;bold&quot;), axis.text = element_text(face = &quot;bold&quot;, size = 12), panel.background = element_blank(), axis.line = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), legend.text = element_text(size = 12), legend.title = element_text(size = 14), legend.position = &quot;right&quot;, legend.box = &quot;vertical&quot; ) +labs(color=&#39;Origin&#39;) 9.2.6.2 Neutral 9.2.6.3 Phylogenetic beta_q1p$S %&gt;% vegan::metaMDS(., trymax = 500, k = 2, trace=0) %&gt;% vegan::scores() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% group_by(locality) %&gt;% mutate(x_cen = median(NMDS1, na.rm = TRUE)) %&gt;% mutate(y_cen = median(NMDS2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% ggplot(aes(x = NMDS1, y = NMDS2, color = locality)) + geom_point(size = 4) + geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9, show.legend = FALSE) + theme_classic() + theme( axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), axis.title = element_text(size = 20, face = &quot;bold&quot;), axis.text = element_text(face = &quot;bold&quot;, size = 18), panel.background = element_blank(), axis.line = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), legend.text = element_text(size = 16), legend.title = element_text(size = 18), legend.position = &quot;right&quot;, legend.box = &quot;vertical&quot; ) + labs(color=&#39;Locality&#39;) 9.2.6.4 Functional beta_q1f$S %&gt;% vegan::metaMDS(., trymax = 500, k = 2, trace=0) %&gt;% vegan::scores() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% dplyr::left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% group_by(locality) %&gt;% mutate(x_cen = median(NMDS1, na.rm = TRUE)) %&gt;% mutate(y_cen = median(NMDS2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% ggplot(aes(x = NMDS1, y = NMDS2, color = locality)) + geom_point(size = 4) + geom_segment(aes(x = x_cen, y = y_cen, xend = NMDS1, yend = NMDS2), alpha = 0.9, show.legend = FALSE) + theme_classic() + theme( axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), axis.title = element_text(size = 20, face = &quot;bold&quot;), axis.text = element_text(face = &quot;bold&quot;, size = 18), panel.background = element_blank(), axis.line = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), legend.text = element_text(size = 16), legend.title = element_text(size = 18), legend.position = &quot;right&quot;, legend.box = &quot;vertical&quot; ) + labs(color=&#39;Locality&#39;) 9.2.7 Permanova analysis sample_metadata_row&lt;- column_to_rownames(sample_metadata, &quot;sample&quot;) sample_metadata_row &lt;- sample_metadata_row[labels(beta_q1n$S), ] Richness betadisper(beta_q0n$S, sample_metadata_row$locality) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 3 0.026956 0.0089854 43.902 999 0.001 *** Residuals 120 0.024560 0.0002047 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Daneborg Disko Illulissat Ittoqqortoormiit Daneborg 1.0000e-03 1.0000e-03 0.415 Disko 5.2192e-11 7.9000e-02 0.001 Illulissat 6.2041e-06 7.6928e-02 0.001 Ittoqqortoormiit 3.8986e-01 3.4240e-18 1.2376e-10 adonis2(beta_q0n$S ~ locality, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() /* tinytable css entries after */ .table td.tinytable_css_s1j9g6qrm6pjp1t2vol5, .table th.tinytable_css_s1j9g6qrm6pjp1t2vol5 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_rihc5zllf0f8kopzkcmq, .table th.tinytable_css_rihc5zllf0f8kopzkcmq { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value locality 3 0.1610129 0.4012651 26.80753 0.001 Residual 120 0.2402503 0.5987349 NA NA Total 123 0.4012633 1.0000000 NA NA Neutral betadisper(beta_q1n$S, sample_metadata_row$locality) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 3 0.36542 0.121807 10.496 999 0.001 *** Residuals 120 1.39266 0.011605 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Daneborg Disko Illulissat Ittoqqortoormiit Daneborg 4.0000e-03 2.1100e-01 0.001 Disko 2.5330e-03 6.4000e-02 0.012 Illulissat 2.1392e-01 6.5566e-02 0.001 Ittoqqortoormiit 1.0351e-05 1.3069e-02 1.9841e-04 adonis2(beta_q1n$S ~ locality, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() /* tinytable css entries after */ .table td.tinytable_css_mucwwz5ikkve17g3sosk, .table th.tinytable_css_mucwwz5ikkve17g3sosk { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_gr8xze36vjy4ewhdrye2, .table th.tinytable_css_gr8xze36vjy4ewhdrye2 { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value locality 3 3.078004 0.2194629 11.24676 0.001 Residual 120 10.947165 0.7805371 NA NA Total 123 14.025168 1.0000000 NA NA pairwise.adonis(beta_q1n$S, sample_metadata$locality, perm = 999) pairs Df SumsOfSqs F.Model R2 p.value 1 Daneborg vs Disko 1 0.3779504 4.170036 0.05622265 0.001 2 Daneborg vs Illulissat 1 1.6374267 21.797752 0.30359937 0.001 3 Daneborg vs Ittoqqortoormiit 1 0.4643954 3.986525 0.06645702 0.001 4 Disko vs Illulissat 1 1.0757063 13.877524 0.17819677 0.001 5 Disko vs Ittoqqortoormiit 1 0.5217785 4.725966 0.06324396 0.001 6 Illulissat vs Ittoqqortoormiit 1 1.2921905 12.569974 0.20089466 0.001 p.adjusted sig 1 0.006 * 2 0.006 * 3 0.006 * 4 0.006 * 5 0.006 * 6 0.006 * Phylogenetic betadisper(beta_q1p$S, sample_metadata_row$locality) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 3 0.08858 0.0295280 4.3569 999 0.007 ** Residuals 120 0.81327 0.0067772 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Daneborg Disko Illulissat Ittoqqortoormiit Daneborg 0.0190000 0.1560000 0.002 Disko 0.0225359 0.4490000 0.143 Illulissat 0.1600611 0.3961635 0.055 Ittoqqortoormiit 0.0036294 0.1421897 0.0534874 adonis2(beta_q1p$S ~ locality, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() /* tinytable css entries after */ .table td.tinytable_css_ikmsdflv8noc0ebpqlj5, .table th.tinytable_css_ikmsdflv8noc0ebpqlj5 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_5txog7j4287imkjrbq0u, .table th.tinytable_css_5txog7j4287imkjrbq0u { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value locality 3 0.5099086 0.1839443 9.016264 0.001 Residual 120 2.2621725 0.8160557 NA NA Total 123 2.7720811 1.0000000 NA NA pairwise.adonis(beta_q1p$S, sample_metadata$locality, perm = 999) pairs Df SumsOfSqs F.Model R2 p.value 1 Daneborg vs Disko 1 0.05550175 3.264910 0.04456308 0.026 2 Daneborg vs Illulissat 1 0.27904627 15.558986 0.23732804 0.001 3 Daneborg vs Ittoqqortoormiit 1 0.12253267 4.814614 0.07916870 0.001 4 Disko vs Illulissat 1 0.12462870 8.463517 0.11679694 0.001 5 Disko vs Ittoqqortoormiit 1 0.11150589 5.306563 0.07046614 0.003 6 Illulissat vs Ittoqqortoormiit 1 0.15930838 6.763703 0.11915542 0.002 p.adjusted sig 1 0.156 2 0.006 * 3 0.006 * 4 0.006 * 5 0.018 . 6 0.012 . Functional betadisper(beta_q1f$S, sample_metadata_row$locality) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 3 0.01060 0.0035320 0.591 999 0.638 Residuals 120 0.71711 0.0059759 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Daneborg Disko Illulissat Ittoqqortoormiit Daneborg 0.33600 0.74100 0.893 Disko 0.33095 0.60600 0.219 Illulissat 0.71280 0.62272 0.605 Ittoqqortoormiit 0.89732 0.23323 0.58629 adonis2(beta_q1f$S ~ place*locality, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() /* tinytable css entries after */ .table td.tinytable_css_rk1ztu8pcxtgxu3qvuou, .table th.tinytable_css_rk1ztu8pcxtgxu3qvuou { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_qp500wq7bhowiyqt4qx9, .table th.tinytable_css_qp500wq7bhowiyqt4qx9 { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value place 1 0.83104455 0.422761281 88.7155127 0.001 locality 2 0.01060646 0.005395619 0.5661293 0.521 Residual 120 1.12410268 0.571843100 NA NA Total 123 1.96575368 1.000000000 NA NA pairwise.adonis(beta_q1f$S, sample_metadata$locality, perm = 999) pairs Df SumsOfSqs F.Model R2 p.value 1 Daneborg vs Disko 1 0.08718865 6.520848 0.08521662 0.032 2 Daneborg vs Illulissat 1 0.34959673 42.942556 0.46203330 0.001 3 Daneborg vs Ittoqqortoormiit 1 0.62329071 96.278680 0.63225318 0.001 4 Disko vs Illulissat 1 0.11734695 8.636601 0.11890150 0.014 5 Disko vs Ittoqqortoormiit 1 0.30178638 25.604223 0.26781477 0.001 6 Illulissat vs Ittoqqortoormiit 1 0.01712494 2.891165 0.05466253 0.165 p.adjusted sig 1 0.192 2 0.006 * 3 0.006 * 4 0.084 5 0.006 * 6 0.990 9.3 Enrichment analysis: Ancombc2 load(&quot;data/ancombc_results.Rdata&quot;) #ancombc_results_wolves.Rdata 9.3.1 MAG level 9.3.2 the global differential taxa res_global &lt;- ancom_rand_output_mag$res_global global_hits &lt;- res_global %&gt;% filter(diff_abn == TRUE) %&gt;% select(taxon, W, p_val, q_val) 9.3.3 Extract the results res_pair &lt;- ancom_rand_output_mag$res_pair # Get log-fold change and q-value columns lfc_cols &lt;- grep(&quot;^lfc_&quot;, colnames(res_pair), value = TRUE) q_cols &lt;- gsub(&quot;^lfc_&quot;, &quot;q_&quot;, lfc_cols) # Build long table by pairing lfc and q for each contrast plot_data &lt;- lfc_cols %&gt;% setNames(nm = .) %&gt;% purrr::imap_dfr(function(lfc_col, name) { q_col &lt;- gsub(&quot;^lfc_&quot;, &quot;q_&quot;, lfc_col) res_pair %&gt;% select(taxon, !!lfc_col, !!q_col) %&gt;% rename( lfc = !!lfc_col, q = !!q_col ) %&gt;% mutate(contrast_key = name) }) %&gt;% filter(!is.na(lfc), !is.na(q), q &lt; 0.05) %&gt;% mutate( # Manually re-label contrasts for clarity contrast = case_when( contrast_key == &quot;lfc_localityDisko&quot; ~ &quot;Disko vs Daneborg&quot;, contrast_key == &quot;lfc_localityIllulissat&quot; ~ &quot;Illulissat vs Daneborg&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit&quot; ~ &quot;Ittoqqortoormiit vs Daneborg&quot;, contrast_key == &quot;lfc_localityMongolia&quot; ~ &quot;Mongolia vs Daneborg&quot;, contrast_key == &quot;lfc_localityIllulissat_localityDisko&quot; ~ &quot;Illulissat vs Disko&quot;, contrast_key == &quot;lfc_localityMongolia_localityDisko&quot; ~ &quot;Mongolia vs Disko&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit_localityDisko&quot; ~ &quot;Ittoqqortoormiit vs Disko&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit_localityIllulissat&quot; ~ &quot;Ittoqqortoormiit vs Illulissat&quot;, contrast_key == &quot;lfc_localityMongolia_localityIllulissat&quot; ~ &quot;Mongolia vs Illulissat&quot;, contrast_key == &quot;lfc_localityMongolia_localityIttoqqortoormiit&quot; ~ &quot;Mongolia vs Ittoqqortoormiit&quot;, TRUE ~ contrast_key ), direction = ifelse(lfc &gt; 0, paste(&quot;Enriched in&quot;, sub(&quot; vs.*&quot;, &quot;&quot;, contrast)), paste(&quot;Enriched in&quot;, sub(&quot;.*vs &quot;, &quot;&quot;, contrast))) ) plot_data &lt;- plot_data %&gt;% left_join(genome_metadata %&gt;% select(genome, phylum), by =join_by(&quot;taxon&quot;==&quot;genome&quot;)) # Loop through each contrast unique_contrasts &lt;- unique(plot_data$contrast) taxonomy &lt;- data.frame(physeq_genome_filtered@tax_table) %&gt;% rownames_to_column(., &quot;taxon&quot;) colors_alphabetic &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate_at(vars(phylum), ~ str_replace(., &quot;[dpcofgs]__&quot;, &quot;&quot;)) %&gt;% right_join(taxonomy, by = join_by(phylum == phylum)) %&gt;% dplyr::select(phylum, colors) %&gt;% mutate(colors = str_c(colors, &quot;80&quot;)) %&gt;% #add 80% alpha unique() %&gt;% dplyr::arrange(phylum) for (c in unique_contrasts) { locs &lt;- str_split(c, &quot; vs &quot;, simplify = TRUE) title &lt;- paste(locs[2], &quot; - &quot;, locs[1])#&quot;Comparison:&quot;, subset_data &lt;- plot_data %&gt;% filter(contrast == c) %&gt;% arrange(direction, lfc) %&gt;% mutate(taxon_ordered = factor(taxon, levels = unique(taxon))) tax_color &lt;- as.data.frame(unique(subset_data$phylum)) %&gt;% rename(phylum = 1) %&gt;% left_join(., colors_alphabetic, by = &quot;phylum&quot;) %&gt;% dplyr::arrange(phylum) %&gt;% dplyr::select(colors) %&gt;% pull() p &lt;- ggplot(subset_data, aes(x = taxon_ordered, y = lfc, fill = phylum)) + geom_bar(stat = &quot;identity&quot;) + coord_flip() + theme( panel.background = element_blank(), axis.line = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 6), axis.title = element_text(size = 14, face = &quot;bold&quot;), legend.text = element_text(size = 12), legend.title = element_text(size = 14, face = &quot;bold&quot;), legend.position = &quot;right&quot;, legend.box = &quot;vertical&quot;, plot.title = element_text(size = 18, face = &quot;bold&quot;, hjust = 0.5) ) + scale_fill_manual(values = tax_color) + labs( title = title, #paste(&quot;Enriched Taxa:&quot;, c) x = &quot;Taxa&quot;, y = &quot;Log-Fold Change&quot;, fill = &quot;Phylum&quot; ) ggsave(paste0(&quot;Fig_&quot;, gsub(&quot; &quot;, &quot;_&quot;, c), &quot;.png&quot;), plot = p, width = 10, height = 25, dpi = 300) } "],["top-10.html", "Chapter 10 top 10 10.1 Functional differences 10.2 Groups MCI 10.3 Community elements differences: 10.4 Community function differences:", " Chapter 10 top 10 for (c in unique_contrasts) { locs &lt;- str_split(c, &quot; vs &quot;, simplify = TRUE) title &lt;- paste(locs[2], &quot; - &quot;, locs[1]) subset_data &lt;- plot_data %&gt;% group_by(contrast) %&gt;% filter(lfc &gt; 0) %&gt;% slice_max(order_by = lfc, n = 10) %&gt;% bind_rows( plot_data %&gt;% group_by(contrast) %&gt;% filter(lfc &lt; 0) %&gt;% slice_min(order_by = lfc, n = 10) ) %&gt;% ungroup() %&gt;% filter(contrast == c) %&gt;% arrange(direction, lfc) %&gt;% mutate(taxon_ordered = factor(taxon, levels = unique(taxon))) tax_color &lt;- as.data.frame(unique(subset_data$phylum)) %&gt;% rename(phylum = 1) %&gt;% left_join(., colors_alphabetic, by = &quot;phylum&quot;) %&gt;% dplyr::arrange(phylum) %&gt;% dplyr::select(colors) %&gt;% pull() p &lt;- ggplot(subset_data, aes(x = taxon_ordered, y = lfc, fill = phylum)) + geom_bar(stat = &quot;identity&quot;) + coord_flip() + theme( panel.background = element_blank(), axis.line = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), axis.title = element_text(size = 14, face = &quot;bold&quot;), legend.text = element_text(size = 12), legend.title = element_text(size = 14, face = &quot;bold&quot;), legend.position = &quot;right&quot;, legend.box = &quot;vertical&quot;, plot.title = element_text(size = 18, face = &quot;bold&quot;) ) + scale_fill_manual(values = tax_color) + labs( title = title, x = &quot;Taxa&quot;, y = &quot;Log-Fold Change&quot;, fill = &quot;Phylum&quot; ) ggsave(paste0(&quot;Fig_top10_&quot;, gsub(&quot; &quot;, &quot;_&quot;, c), &quot;.png&quot;), plot = p, width = 8, height = 12, dpi = 300) } 10.0.1 Phylum level res_pair_phylum &lt;- ancom_rand_output_phylum$res_pair # Get log-fold change and q-value columns lfc_cols &lt;- grep(&quot;^lfc_&quot;, colnames(res_pair_phylum), value = TRUE) q_cols &lt;- gsub(&quot;^lfc_&quot;, &quot;q_&quot;, lfc_cols) # Build long table by pairing lfc and q for each contrast plot_data_phylum &lt;- lfc_cols %&gt;% setNames(nm = .) %&gt;% purrr::imap_dfr(function(lfc_col, name) { q_col &lt;- gsub(&quot;^lfc_&quot;, &quot;q_&quot;, lfc_col) res_pair_phylum %&gt;% select(taxon, !!lfc_col, !!q_col) %&gt;% rename( lfc = !!lfc_col, q = !!q_col ) %&gt;% mutate(contrast_key = name) }) %&gt;% filter(!is.na(lfc), !is.na(q), q &lt; 0.05) %&gt;% mutate( # Manually re-label contrasts for clarity contrast = case_when( contrast_key == &quot;lfc_localityDisko&quot; ~ &quot;Disko vs Daneborg&quot;, contrast_key == &quot;lfc_localityIllulissat&quot; ~ &quot;Illulissat vs Daneborg&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit&quot; ~ &quot;Ittoqqortoormiit vs Daneborg&quot;, contrast_key == &quot;lfc_localityMongolia&quot; ~ &quot;Mongolia vs Daneborg&quot;, contrast_key == &quot;lfc_localityIllulissat_localityDisko&quot; ~ &quot;Illulissat vs Disko&quot;, contrast_key == &quot;lfc_localityMongolia_localityDisko&quot; ~ &quot;Mongolia vs Disko&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit_localityDisko&quot; ~ &quot;Ittoqqortoormiit vs Disko&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit_localityIllulissat&quot; ~ &quot;Ittoqqortoormiit vs Illulissat&quot;, contrast_key == &quot;lfc_localityMongolia_localityIllulissat&quot; ~ &quot;Mongolia vs Illulissat&quot;, contrast_key == &quot;lfc_localityMongolia_localityIttoqqortoormiit&quot; ~ &quot;Mongolia vs Ittoqqortoormiit&quot;, TRUE ~ contrast_key ), direction = ifelse(lfc &gt; 0, paste(&quot;Enriched in&quot;, sub(&quot; vs.*&quot;, &quot;&quot;, contrast)), paste(&quot;Enriched in&quot;, sub(&quot;.*vs &quot;, &quot;&quot;, contrast))) ) # Loop through each contrast unique_contrasts &lt;- unique(plot_data_phylum$contrast) taxonomy &lt;- data.frame(physeq_genome_filtered@tax_table) %&gt;% rownames_to_column(., &quot;taxon&quot;) colors_alphabetic &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate_at(vars(phylum), ~ str_replace(., &quot;[dpcofgs]__&quot;, &quot;&quot;)) %&gt;% right_join(taxonomy, by=join_by(phylum == phylum)) %&gt;% dplyr::select(phylum, colors) %&gt;% mutate(colors = str_c(colors, &quot;80&quot;)) %&gt;% #add 80% alpha unique() %&gt;% dplyr::arrange(phylum) for (c in unique_contrasts) { locs &lt;- str_split(c, &quot; vs &quot;, simplify = TRUE) title &lt;- paste(locs[2], &quot; - &quot;, locs[1])# subset_data_phylum &lt;- plot_data_phylum %&gt;% filter(contrast == c) %&gt;% arrange(direction, lfc) %&gt;% mutate(taxon_ordered = factor(taxon, levels = unique(taxon))) tax_color &lt;- as.data.frame(unique(subset_data_phylum$taxon)) %&gt;% rename(phylum = 1) %&gt;% left_join(., colors_alphabetic, by = &quot;phylum&quot;) %&gt;% dplyr::arrange(phylum) %&gt;% dplyr::select(colors) %&gt;% pull() p &lt;- ggplot(subset_data_phylum, aes(x = taxon_ordered, y = lfc, fill = taxon)) + geom_bar(stat = &quot;identity&quot;, show.legend = FALSE) + coord_flip() + theme( panel.background = element_blank(), axis.line = element_line( size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot; ), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), axis.title = element_text(size = 14, face = &quot;bold&quot;), legend.text = element_blank(), legend.title = element_blank(), plot.title = element_text(size = 18, face = &quot;bold&quot;, hjust = 0.5) ) + scale_fill_manual(values = tax_color) + labs( title = title, x = &quot;Taxa&quot;, y = &quot;Log-Fold Change&quot;, ) ggsave(paste0(&quot;Fig_phylum_&quot;, gsub(&quot; &quot;, &quot;_&quot;, c), &quot;.png&quot;), plot = p, width = 6, height = 8, dpi = 300) } 10.0.2 Genus level save(ancom_rand_output_mag, ancom_rand_output_phylum, ancom_rand_output_genus, file = &quot;data/ancombc_results.Rdata&quot;) #ancombc_results_wolves.Rdata res_pair_genus &lt;- ancom_rand_output_genus$res_pair # Get log-fold change and q-value columns lfc_cols &lt;- grep(&quot;^lfc_&quot;, colnames(res_pair_genus), value = TRUE) q_cols &lt;- gsub(&quot;^lfc_&quot;, &quot;q_&quot;, lfc_cols) # Build long table by pairing lfc and q for each contrast plot_data_genus &lt;- lfc_cols %&gt;% setNames(nm = .) %&gt;% purrr::imap_dfr(function(lfc_col, name) { q_col &lt;- gsub(&quot;^lfc_&quot;, &quot;q_&quot;, lfc_col) res_pair_genus %&gt;% select(taxon, !!lfc_col, !!q_col) %&gt;% rename( lfc = !!lfc_col, q = !!q_col ) %&gt;% mutate(contrast_key = name) }) %&gt;% filter(!is.na(lfc), !is.na(q), q &lt; 0.05) %&gt;% mutate( # Manually re-label contrasts for clarity contrast = case_when( contrast_key == &quot;lfc_localityDisko&quot; ~ &quot;Disko vs Daneborg&quot;, contrast_key == &quot;lfc_localityIllulissat&quot; ~ &quot;Illulissat vs Daneborg&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit&quot; ~ &quot;Ittoqqortoormiit vs Daneborg&quot;, contrast_key == &quot;lfc_localityMongolia&quot; ~ &quot;Mongolia vs Daneborg&quot;, contrast_key == &quot;lfc_localityIllulissat_localityDisko&quot; ~ &quot;Illulissat vs Disko&quot;, contrast_key == &quot;lfc_localityMongolia_localityDisko&quot; ~ &quot;Mongolia vs Disko&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit_localityDisko&quot; ~ &quot;Ittoqqortoormiit vs Disko&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit_localityIllulissat&quot; ~ &quot;Ittoqqortoormiit vs Illulissat&quot;, contrast_key == &quot;lfc_localityMongolia_localityIllulissat&quot; ~ &quot;Mongolia vs Illulissat&quot;, contrast_key == &quot;lfc_localityMongolia_localityIttoqqortoormiit&quot; ~ &quot;Mongolia vs Ittoqqortoormiit&quot;, TRUE ~ contrast_key ), direction = ifelse(lfc &gt; 0, paste(&quot;Enriched in&quot;, sub(&quot; vs.*&quot;, &quot;&quot;, contrast)), paste(&quot;Enriched in&quot;, sub(&quot;.*vs &quot;, &quot;&quot;, contrast))) ) plot_data_genus &lt;- plot_data_genus %&gt;% mutate(taxon_clean = sub(&quot;.*:&quot;, &quot;&quot;, taxon)) %&gt;% left_join(., genome_metadata %&gt;% select(genus, family, phylum) %&gt;% distinct(), by =join_by(&quot;taxon_clean&quot;==&quot;genus&quot;))%&gt;% left_join(., genome_metadata %&gt;% select(family, phylum)%&gt;% distinct(), by =join_by(&quot;taxon_clean&quot;==&quot;family&quot;)) %&gt;% mutate(phylum.x = coalesce(phylum.x, phylum.y)) %&gt;% select(-family,-phylum.y) %&gt;% rename(phylum=phylum.x) # Loop through each contrast unique_contrasts &lt;- unique(plot_data_genus$contrast) taxonomy &lt;- data.frame(physeq_genome_filtered@tax_table) %&gt;% rownames_to_column(., &quot;taxon&quot;) colors_alphabetic &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate_at(vars(phylum), ~ str_replace(., &quot;[dpcofgs]__&quot;, &quot;&quot;)) %&gt;% right_join(taxonomy, by=join_by(phylum == phylum)) %&gt;% dplyr::select(phylum, colors) %&gt;% mutate(colors = str_c(colors, &quot;80&quot;)) %&gt;% #add 80% alpha unique() %&gt;% dplyr::arrange(phylum) for (c in unique_contrasts) { locs &lt;- str_split(c, &quot; vs &quot;, simplify = TRUE) titulu &lt;- paste(locs[2], &quot; - &quot;, locs[1]) subset_data_genus &lt;- plot_data_genus %&gt;% filter(contrast == c) %&gt;% arrange(direction, lfc) # %&gt;% mutate(taxon_ordered = factor(taxon_clean, levels = unique(taxon_clean))) tax_color &lt;- as.data.frame(unique(subset_data_genus$phylum)) %&gt;% rename(phylum=1) %&gt;% left_join(., colors_alphabetic, by=&quot;phylum&quot;)%&gt;% dplyr::arrange(phylum) %&gt;% dplyr::select(colors) %&gt;% pull() p &lt;- ggplot(subset_data_genus, aes(x=lfc, y=forcats::fct_reorder(taxon_clean,lfc), fill=phylum)) + geom_bar(stat = &quot;identity&quot;) + # coord_flip() + theme(panel.background = element_blank(), axis.line = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 8), axis.title = element_text(size = 12, face = &quot;bold&quot;), legend.text = element_text(size = 12), legend.title = element_text(size = 14, face = &quot;bold&quot;), legend.position = &quot;right&quot;, legend.box = &quot;vertical&quot;, plot.title = element_text(size = 16, face = &quot;bold&quot;, hjust = 0.5))+ scale_fill_manual(values=tax_color) + labs( title = titulu, x = &quot;Taxa&quot;, y = &quot;Log-Fold Change&quot;, fill = &quot;Direction&quot; ) ggsave(paste0(&quot;Fig_genus_&quot;, gsub(&quot; &quot;, &quot;_&quot;, c), &quot;.png&quot;), plot = p, width = 6, height = 10, dpi = 300) } # Loop through each contrast plot_data_genus &lt;- lfc_cols %&gt;% setNames(nm = .) %&gt;% purrr::imap_dfr(function(lfc_col, name) { q_col &lt;- gsub(&quot;^lfc_&quot;, &quot;q_&quot;, lfc_col) res_pair_genus %&gt;% select(taxon, !!lfc_col, !!q_col) %&gt;% rename( lfc = !!lfc_col, q = !!q_col ) %&gt;% mutate(contrast_key = name) }) %&gt;% filter(!is.na(lfc), !is.na(q), q &lt; 0.05) %&gt;% mutate( # Manually re-label contrasts for clarity contrast = case_when( contrast_key == &quot;lfc_localityDisko&quot; ~ &quot;Disko vs Daneborg&quot;, contrast_key == &quot;lfc_localityIllulissat&quot; ~ &quot;Illulissat vs Daneborg&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit&quot; ~ &quot;Ittoqqortoormiit vs Daneborg&quot;, contrast_key == &quot;lfc_localityMongolia&quot; ~ &quot;Mongolia vs Daneborg&quot;, contrast_key == &quot;lfc_localityIllulissat_localityDisko&quot; ~ &quot;Illulissat vs Disko&quot;, contrast_key == &quot;lfc_localityMongolia_localityDisko&quot; ~ &quot;Mongolia vs Disko&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit_localityDisko&quot; ~ &quot;Ittoqqortoormiit vs Disko&quot;, contrast_key == &quot;lfc_localityIttoqqortoormiit_localityIllulissat&quot; ~ &quot;Ittoqqortoormiit vs Illulissat&quot;, contrast_key == &quot;lfc_localityMongolia_localityIllulissat&quot; ~ &quot;Mongolia vs Illulissat&quot;, contrast_key == &quot;lfc_localityMongolia_localityIttoqqortoormiit&quot; ~ &quot;Mongolia vs Ittoqqortoormiit&quot;, TRUE ~ contrast_key ), direction = ifelse(lfc &gt; 0, paste(&quot;Enriched in&quot;, sub(&quot; vs.*&quot;, &quot;&quot;, contrast)), paste(&quot;Enriched in&quot;, sub(&quot;.*vs &quot;, &quot;&quot;, contrast))) ) plot_data_genusF &lt;- plot_data_genus %&gt;% mutate(taxon_clean = sub(&quot;.*:&quot;, &quot;&quot;, taxon)) %&gt;% left_join(., genome_metadata %&gt;% select(genus, class, phylum) %&gt;% distinct(), by =join_by(&quot;taxon_clean&quot;==&quot;genus&quot;))%&gt;% left_join(., genome_metadata %&gt;% select(family, class, phylum)%&gt;% distinct(), by =join_by(&quot;taxon_clean&quot;==&quot;family&quot;)) %&gt;% mutate(class.x = coalesce(class.x, class.y)) %&gt;% select(-class.y) %&gt;% rename(class=class.x) unique_contrasts &lt;- unique(plot_data_genus$contrast) # taxonomy &lt;- data.frame(physeq_genome_filtered@tax_table) %&gt;% # rownames_to_column(., &quot;taxon&quot;) # colors_alphabetic &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% # mutate_at(vars(phylum), ~ str_replace(., &quot;[dpcofgs]__&quot;, &quot;&quot;)) %&gt;% # right_join(taxonomy, by=join_by(phylum == phylum)) %&gt;% # dplyr::select(phylum, colors) %&gt;% # mutate(colors = str_c(colors, &quot;80&quot;)) %&gt;% #add 80% alpha # unique() %&gt;% # dplyr::arrange(phylum) for (c in unique_contrasts) { locs &lt;- str_split(c, &quot; vs &quot;, simplify = TRUE) titulu &lt;- paste(locs[2], &quot; - &quot;, locs[1]) subset_data_genusF &lt;- plot_data_genusF %&gt;% filter(contrast == c) %&gt;% arrange(direction, lfc) # %&gt;% mutate(taxon_ordered = factor(taxon_clean, levels = unique(taxon_clean))) # tax_color &lt;- as.data.frame(unique(subset_data_genus$phylum)) %&gt;% # rename(phylum=1) %&gt;% # left_join(., colors_alphabetic, by=&quot;phylum&quot;)%&gt;% # dplyr::arrange(phylum) %&gt;% # dplyr::select(colors) %&gt;% # pull() p_f &lt;- ggplot(subset_data_genusF, aes(x=lfc, y=forcats::fct_reorder(taxon_clean,lfc), fill=class)) + geom_bar(stat = &quot;identity&quot;) + # coord_flip() + theme(panel.background = element_blank(), axis.line = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 10), axis.title = element_text(size = 12, face = &quot;bold&quot;), legend.text = element_text(size = 12), legend.title = element_text(size = 14, face = &quot;bold&quot;), legend.position = &quot;right&quot;, legend.box = &quot;vertical&quot;, plot.title = element_text(size = 16, face = &quot;bold&quot;, hjust = 0.5))+ scale_fill_discrete()+ labs( title = titulu, x = &quot;Taxa&quot;, y = &quot;Log-Fold Change&quot;, fill = &quot;Faily&quot; ) ggsave(paste0(&quot;Fig_genus_color_family_&quot;, gsub(&quot; &quot;, &quot;_&quot;, c), &quot;.png&quot;), plot = p_f, width = 10, height = 20, dpi = 300) } 10.1 Functional differences 10.2 Groups MCI GIFTs_functions_community %&gt;% rowMeans() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% # filter(time_point==&quot;0_Wild&quot;) %&gt;% group_by(locality) %&gt;% summarise(MCI = mean(value), sd = sd(value)) %&gt;% tt() /* tinytable css entries after */ .table td.tinytable_css_f25oxzaldzt1hd0eml70, .table th.tinytable_css_f25oxzaldzt1hd0eml70 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_53c8c9e0ujn3k1tdm369, .table th.tinytable_css_53c8c9e0ujn3k1tdm369 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } locality MCI sd Daneborg 0.3613817 0.003219451 Disko 0.3618705 0.007201916 Illulissat 0.3636198 0.003564632 Ittoqqortoormiit 0.3649810 0.014306168 MCI &lt;- GIFTs_functions_community %&gt;% rowMeans() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == sample)) shapiro.test(MCI$value) ## ## Shapiro-Wilk normality test ## ## data: MCI$value ## W = 0.75702, p-value = 4.793e-13 kruskal.test(value ~ locality, data=MCI) ## ## Kruskal-Wallis rank sum test ## ## data: value by locality ## Kruskal-Wallis chi-squared = 5.536, df = 3, p-value = 0.1365 10.3 Community elements differences: ggplot(pairwise_results, aes(x = comparison, y = fct_rev(Function))) + geom_tile(aes(fill = p.adj), color = &quot;white&quot;) + geom_text(aes(label = p.adj.signif), size = 4, color = &quot;black&quot;) + scale_fill_gradient(low = &quot;#b30000&quot;, high = &quot;#fef0d9&quot; , name = &quot;Adjusted p-value&quot;) + theme_minimal() + labs( title = &quot;Significant Pairwise Comparisons by Trait&quot;, x = &quot;Locality Comparison&quot;, y = &quot;Trait&quot; ) + theme( axis.text.x = element_text(angle = 45, hjust = 1), panel.grid = element_blank() ) 10.4 Community function differences: ggplot(pairwise_results_func, aes(x = comparison, y = fct_rev(Function))) + geom_tile(aes(fill = p.adj), color = &quot;white&quot;) + geom_text(aes(label = p.adj.signif), size = 4, color = &quot;black&quot;) + scale_fill_gradient(low = &quot;#b30000&quot;, high = &quot;#fef0d9&quot; , name = &quot;Adjusted p-value&quot;) + theme_minimal() + labs( title = &quot;Significant Pairwise Comparisons by Trait&quot;, x = &quot;Locality Comparison&quot;, y = &quot;Trait&quot; ) + theme( axis.text.x = element_text(angle = 45, hjust = 1), panel.grid = element_blank() ) 10.4.1 With wolves load(&quot;data/data.Rdata&quot;) load(&quot;data/beta_greenland_wolves.Rdata&quot;) sample_metadata &lt;- read_csv(&quot;data/sample_metadata.csv&quot;) sample_metadata &lt;- sample_metadata %&gt;% filter(country== &quot;Greenland&quot; | breed == &quot;Wolf&quot;) sample_metadata$individual &lt;- sub(&quot;[0-9]{2}$&quot;, &quot;&quot;, sample_metadata$animal) sample_metadata_illu &lt;- read_csv(&quot;data/metadata_illu.csv&quot;) sample_metadata &lt;- sample_metadata %&gt;% left_join(sample_metadata_illu[c(1,4,9)], by=join_by(&quot;sample&quot;==&quot;DogID&quot;)) %&gt;% filter(!Samples %in% c(&quot;Blank&quot;,&quot;Saliva&quot;)) %&gt;% filter(individual!=&quot;GL_02_&quot;) %&gt;% filter(season!=&quot;winter&quot;) genome_counts_filt &lt;- genome_counts_filt %&gt;% select(one_of(c(&quot;genome&quot;,sample_metadata$sample)))%&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) genome_metadata &lt;- genome_metadata %&gt;% semi_join(., genome_counts_filt, by = &quot;genome&quot;) %&gt;% arrange(match(genome,genome_counts_filt$genome)) genome_tree &lt;- keep.tip(genome_tree, tip=genome_metadata$genome) Neutral sample_metadata_row&lt;- column_to_rownames(sample_metadata, &quot;sample&quot;) sample_metadata_row &lt;- sample_metadata_row[labels(beta_q1n$S), ] betadisper(beta_q1n$S, sample_metadata_row$locality) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 4 0.3703 0.092576 8.001 999 0.001 *** Residuals 126 1.4579 0.011571 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Daneborg Disko Illulissat Ittoqqortoormiit Mongolia Daneborg 4.0000e-03 2.2500e-01 1.0000e-03 0.054 Disko 2.5276e-03 6.1000e-02 1.1000e-02 0.723 Illulissat 2.1374e-01 6.5615e-02 1.0000e-03 0.096 Ittoqqortoormiit 1.0276e-05 1.3075e-02 1.9819e-04 0.263 Mongolia 5.7981e-02 7.4099e-01 1.1248e-01 2.7849e-01 adonis2(beta_q1n$S ~ locality, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() /* tinytable css entries after */ .table td.tinytable_css_ou5xats2432r2fy1ktly, .table th.tinytable_css_ou5xats2432r2fy1ktly { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_1w9lr9mida9erjepyv77, .table th.tinytable_css_1w9lr9mida9erjepyv77 { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value locality 4 4.028089 0.2573208 10.91401 0.001 Residual 126 11.625868 0.7426792 NA NA Total 130 15.653957 1.0000000 NA NA pairwise.adonis(beta_q1n$S, sample_metadata$locality, perm = 999) pairs Df SumsOfSqs F.Model R2 p.value 1 Daneborg vs Disko 1 2.0141969 25.463759 0.26673744 0.001 2 Daneborg vs Illulissat 1 1.4384669 23.686570 0.32145030 0.001 3 Daneborg vs Ittoqqortoormiit 1 1.4949672 15.128293 0.21269023 0.001 4 Daneborg vs Mongolia 1 0.9660845 14.541670 0.29957086 0.001 5 Disko vs Illulissat 1 0.2207961 2.610421 0.03918938 0.011 6 Disko vs Ittoqqortoormiit 1 0.5283427 4.675183 0.06260692 0.001 7 Disko vs Mongolia 1 0.9770179 10.116602 0.17407421 0.001 8 Illulissat vs Ittoqqortoormiit 1 0.4332439 4.004008 0.07414279 0.001 9 Illulissat vs Mongolia 1 0.9431293 12.368577 0.30639120 0.001 10 Ittoqqortoormiit vs Mongolia 1 0.9467617 6.948745 0.16969371 0.001 p.adjusted sig 1 0.01 * 2 0.01 * 3 0.01 * 4 0.01 * 5 0.11 6 0.01 * 7 0.01 * 8 0.01 * 9 0.01 * 10 0.01 * "],["winter-vs-summer-in-eastern-greenland.html", "Chapter 11 Winter vs summer in eastern Greenland 11.1 Enrichment analysis: Ancombc2 11.2 Groups MCI", " Chapter 11 Winter vs summer in eastern Greenland load(&quot;data/data.Rdata&quot;) sample_metadata &lt;- read_csv(&quot;data/sample_metadata.csv&quot;) sample_metadata &lt;- sample_metadata%&gt;% filter(country== &quot;Greenland&quot;) sample_metadata$individual &lt;- sub(&quot;[0-9]{2}$&quot;, &quot;&quot;, sample_metadata$animal) sample_metadata_illu &lt;- read_csv(&quot;data/metadata_illu.csv&quot;) sample_metadata &lt;- sample_metadata %&gt;% left_join(sample_metadata_illu[c(1,4,9)], by=join_by(&quot;sample&quot;==&quot;DogID&quot;)) %&gt;% filter(!Samples %in% c(&quot;Blank&quot;,&quot;Saliva&quot;)) %&gt;% filter(individual!=&quot;GL_02_&quot;) %&gt;% filter(locality %in% c(&quot;Ittoqqortoormiit&quot;)) %&gt;% #, &quot;Daneborg&quot; # filter(season==&quot;winter&quot;) %&gt;% filter(day %in% c(&quot;day_1&quot;, &quot;Unknown&quot;)) genome_counts_filt &lt;- genome_counts_filt %&gt;% select(one_of(c(&quot;genome&quot;,sample_metadata$sample)))%&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) genome_metadata &lt;- genome_metadata %&gt;% semi_join(., genome_counts_filt, by = &quot;genome&quot;) %&gt;% arrange(match(genome,genome_counts_filt$genome)) genome_tree &lt;- keep.tip(genome_tree, tip=genome_metadata$genome) # Calculate Hill numbers richness &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 0) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(richness = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) neutral &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(neutral = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) phylogenetic &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1, tree = genome_tree) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(phylogenetic = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) # Merge all metrics alpha_div &lt;- richness %&gt;% full_join(neutral, by = join_by(sample == sample)) %&gt;% full_join(phylogenetic, by = join_by(sample == sample)) beta_q1n &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% filter(rowSums(. != 0, na.rm = TRUE) &gt; 0) %&gt;% select_if(~!all(. == 0)) %&gt;% hillpair(., q = 1) 11.0.1 Beta diversity plots 11.0.1.1 Neutral 11.0.2 Permanova analysis sample_metadata_row&lt;- column_to_rownames(sample_metadata, &quot;sample&quot;) sample_metadata_row &lt;- sample_metadata_row[labels(beta_q1n$S), ] Neutral betadisper(beta_q1n$S, sample_metadata_row$season) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 1 0.10058 0.100577 6.9392 999 0.017 * Residuals 41 0.59425 0.014494 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) summer winter summer 0.015 winter 0.011843 adonis2(beta_q1n$S ~ season, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() /* tinytable css entries after */ .table td.tinytable_css_wyjcz1tq6qxto86ucnbp, .table th.tinytable_css_wyjcz1tq6qxto86ucnbp { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_ibygh0ga1q7h23a9uq9v, .table th.tinytable_css_ibygh0ga1q7h23a9uq9v { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value season 1 0.3060651 0.05747069 2.499973 0.004 Residual 41 5.0195204 0.94252931 NA NA Total 42 5.3255854 1.00000000 NA NA 11.1 Enrichment analysis: Ancombc2 load(&quot;data/ancombc_results_itto.Rdata&quot;) #ancombc_results_wolves.Rdata 11.1.0.1 MAG level 11.1.1 Phylum level res_pair_phylum_itto &lt;- ancom_rand_output_phylum_itto$res_pair ancom_rand_output_phylum_itto$res %&gt;% dplyr::select(taxon, lfc_seasonwinter, p_seasonwinter) %&gt;% filter(p_seasonwinter &lt; 0.05) %&gt;% dplyr::arrange(p_seasonwinter) ## taxon lfc_seasonwinter p_seasonwinter ## 1 Campylobacterota -1.1014656 0.0001563804 ## 2 Desulfobacterota 1.7018005 0.0030389535 ## 3 Pseudomonadota -0.6580040 0.0229039008 ## 4 Bacillota_C -0.6600143 0.0272474391 11.1.2 Genus level ancom_rand_output_genus_itto$res %&gt;% dplyr::select(taxon, lfc_seasonwinter, p_seasonwinter) %&gt;% filter(p_seasonwinter &lt; 0.05) %&gt;% dplyr::arrange(p_seasonwinter) ## taxon lfc_seasonwinter p_seasonwinter ## 1 genus:Bergeyella -5.4660357 2.054375e-10 ## 2 genus:Rhodococcus -4.3171746 3.090896e-09 ## 3 genus:Brevundimonas -2.5272227 5.535344e-07 ## 4 genus:Glutamicibacter -2.0123431 4.169763e-06 ## 5 genus:Allisonella -4.6856729 4.178579e-06 ## 6 genus:Hanamia -2.0536816 4.510481e-06 ## 7 genus:Catellicoccus -2.6638459 6.792692e-06 ## 8 genus:Comamonas -1.8993513 1.093151e-05 ## 9 genus:Fimiplasma 2.9158081 1.238737e-05 ## 10 genus:Amulumruptor -1.9600759 1.836268e-05 ## 11 genus:Bhargavaea -2.0301076 2.318791e-05 ## 12 genus:Knoellia -1.9858626 2.410935e-05 ## 13 genus:Megamonas -3.4590349 3.003377e-05 ## 14 genus:Longicatena 3.8611986 5.339337e-05 ## 15 genus:JADKAV01 -1.8525886 5.409100e-05 ## 16 genus:Merdicola -2.5781431 1.270891e-04 ## 17 genus:Rothia -1.5754627 1.666881e-04 ## 18 genus:Psychrobacter -2.7321156 1.677950e-04 ## 19 genus:Campylobacter_D -1.6333270 1.913538e-04 ## 20 genus:Moraxella -1.4099891 2.485894e-04 ## 21 genus:W0P28-013 2.4210797 2.503891e-04 ## 22 genus:Terracoccus -1.9922105 2.859803e-04 ## 23 genus:Giesbergeria -1.7242448 2.944654e-04 ## 24 genus:Sanguibacter -1.7346204 3.173746e-04 ## 25 genus:UBA2868 -1.2441571 3.202459e-04 ## 26 genus:Oceanobacillus -1.3461817 3.833470e-04 ## 27 genus:Bacillus_AD -1.3344536 4.339856e-04 ## 28 genus:CALVGN01 1.8679454 5.442168e-04 ## 29 genus:Cellvibrio -1.8887339 5.658234e-04 ## 30 genus:Plesiomonas -2.0484058 6.995737e-04 ## 31 genus:Proteus -1.8597305 8.157405e-04 ## 32 genus:UMGS1370 -1.2783094 8.338675e-04 ## 33 genus:Lysinibacillus_B -1.8480954 8.701480e-04 ## 34 genus:Pseudomonas_E -2.6786890 8.759535e-04 ## 35 genus:UBA4644 -1.1076514 1.386799e-03 ## 36 genus:Frederiksenia -1.5008751 1.441349e-03 ## 37 genus:Faecalitalea 1.6942164 1.982288e-03 ## 38 genus:Pasteurella -1.2592775 2.574284e-03 ## 39 genus:Ileibacterium 2.5709571 2.608721e-03 ## 40 genus:Lampropedia -1.2462215 3.241740e-03 ## 41 genus:Taurinivorans 1.7018005 3.520756e-03 ## 42 genus:Hathewaya -2.7267265 3.551471e-03 ## 43 genus:Flavonifractor -1.4966567 4.133116e-03 ## 44 genus:Beduini -0.9304047 6.524845e-03 ## 45 genus:Weissella -1.2543510 6.775560e-03 ## 46 genus:Parabacteroides -1.2908072 7.709186e-03 ## 47 genus:Eikenella -1.4824217 7.888231e-03 ## 48 genus:W11650 -1.0234280 8.510491e-03 ## 49 genus:Flavobacterium -1.2373240 9.146216e-03 ## 50 genus:Parasutterella -1.5511979 9.612613e-03 ## 51 genus:CAJMNU01 1.7511078 1.004348e-02 ## 52 genus:Barnesiella -1.3009204 1.074752e-02 ## 53 genus:JABFRO01 -0.8078856 1.107917e-02 ## 54 genus:Ruminococcus_E -1.0715751 1.252295e-02 ## 55 genus:Cutibacterium -0.9755837 1.258812e-02 ## 56 genus:51-20 -0.9645991 1.283230e-02 ## 57 genus:UBA866 -1.5289671 1.295620e-02 ## 58 genus:Helicobacter_D -1.7177397 1.316404e-02 ## 59 genus:CAG-177 -0.9487066 1.360657e-02 ## 60 family:Sphingobacteriaceae -0.7860765 1.363599e-02 ## 61 genus:Merdivicinus -2.3124623 1.430489e-02 ## 62 genus:CALUZH01 1.1710543 1.577868e-02 ## 63 genus:Schaedlerella 0.8593948 1.601248e-02 ## 64 genus:Lepagella -1.2562184 1.627307e-02 ## 65 genus:UBA4285 1.1064059 1.677116e-02 ## 66 genus:Veillonella_A -1.0159884 1.890069e-02 ## 67 genus:Fimicola -1.4909929 1.891906e-02 ## 68 genus:Enterobacter -1.8059725 1.945087e-02 ## 69 genus:Zhenhengia -1.9201391 1.955843e-02 ## 70 genus:Helicobacter_G -2.4163934 2.074263e-02 ## 71 genus:CALDMQ01 0.8455211 2.116450e-02 ## 72 genus:Faecalibaculum -0.6721295 2.125302e-02 ## 73 genus:RGIG7332 -2.1040586 2.354080e-02 ## 74 genus:JAUMXB01 -0.8729714 2.395607e-02 ## 75 genus:Providencia_C -1.4633751 2.512345e-02 ## 76 genus:Aphodosoma -0.9966387 2.933186e-02 ## 77 genus:Duodenibacillus 0.8856432 2.974103e-02 ## 78 genus:Scybalocola -0.8414392 3.123578e-02 ## 79 genus:Catenibacterium 1.7942230 3.182599e-02 ## 80 family:Lachnospiraceae -0.6416233 3.363199e-02 ## 81 genus:Fournierella 0.9674455 3.578715e-02 ## 82 genus:Limisoma -0.9079708 3.594382e-02 ## 83 genus:Odoribacter -1.4820043 3.721018e-02 ## 84 genus:CAJUPY01 0.9344755 3.921886e-02 ## 85 genus:Psychrobacillus -0.9734341 4.223821e-02 ## 86 genus:Coproplasma -0.7068746 4.611504e-02 ## 87 genus:Acetatifactor -1.3026542 4.678134e-02 ## 88 genus:JAHHTG01 2.0497856 4.729871e-02 ## 89 genus:Holtiella -0.9259568 4.900440e-02 ## 90 genus:Leuconostoc -0.8407728 4.956790e-02 save(ancom_rand_output_mag_itto, ancom_rand_output_phylum_itto, ancom_rand_output_genus_itto, file = &quot;data/ancombc_results_itto.Rdata&quot;) #ancombc_results_wolves.Rdata 11.2 Groups MCI GIFTs_functions_community %&gt;% rowMeans() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == sample)) %&gt;% group_by(season) %&gt;% summarise(MCI = mean(value), sd = sd(value)) %&gt;% tt() /* tinytable css entries after */ .table td.tinytable_css_sejuvj81v0lxtkdmqohr, .table th.tinytable_css_sejuvj81v0lxtkdmqohr { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_8tef2samk5t8pjusczep, .table th.tinytable_css_8tef2samk5t8pjusczep { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } season MCI sd summer 0.3713591 0.012780176 winter 0.3643679 0.006296641 Shapiro test MCI &lt;- GIFTs_functions_community %&gt;% rowMeans() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == sample)) shapiro.test(MCI$value) ## ## Shapiro-Wilk normality test ## ## data: MCI$value ## W = 0.94431, p-value = 0.03707 wilcox.test(value ~ season, data=MCI) ## ## Wilcoxon rank sum exact test ## ## data: value by season ## W = 267, p-value = 0.1002 ## alternative hypothesis: true location shift is not equal to 0 11.2.1 Community elements differences: element_gift &lt;- GIFTs_elements_community %&gt;% as.data.frame() %&gt;% rownames_to_column(., &quot;sample&quot;) %&gt;% left_join(., sample_metadata[c(1,8)], by=join_by(&quot;sample&quot;==&quot;sample&quot;)) uniqueGIFT_db&lt;- unique(GIFT_db[c(2,4,5,6)]) %&gt;% unite(&quot;Function&quot;,Function:Element, sep= &quot;_&quot;, remove=FALSE) significant_elements &lt;- element_gift %&gt;% pivot_longer(-c(sample,season), names_to = &quot;trait&quot;, values_to = &quot;value&quot;) %&gt;% group_by(trait) %&gt;% summarise(p_value = wilcox.test(value ~ season)$p.value) %&gt;% mutate(p_adjust=p.adjust(p_value, method=&quot;BH&quot;)) %&gt;% filter(p_adjust &lt; 0.05)%&gt;% rownames_to_column(., &quot;Elements&quot;) %&gt;% left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element)) element_gift_t &lt;- element_gift %&gt;% t() %&gt;% row_to_names(row_number = 1) %&gt;% as.data.frame() %&gt;% mutate_if(is.character, as.numeric) %&gt;% rownames_to_column(., &quot;trait&quot;) element_gift_filt &lt;- subset(element_gift_t, trait %in% significant_elements$trait) %&gt;% t() %&gt;% row_to_names(row_number = 1) %&gt;% as.data.frame() %&gt;% mutate_if(is.character, as.numeric) %&gt;% rownames_to_column(., &quot;sample&quot;)%&gt;% left_join(., sample_metadata[c(1,8)], by = join_by(sample == sample)) element_gift_filt %&gt;% select(-sample)%&gt;% group_by(season) %&gt;% summarise(across(everything(), mean))%&gt;% t() %&gt;% row_to_names(row_number = 1) %&gt;% as.data.frame() %&gt;% mutate_if(is.character, as.numeric) %&gt;% rownames_to_column(., &quot;Elements&quot;) %&gt;% left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(Elements == Code_element)) Elements summer winter 1 B0219 0.09146355 0.06715347 2 B0401 0.91270410 0.94524290 3 B0709 0.06836937 0.03939824 4 D0211 0.09297240 0.06855180 5 D0505 0.44136870 0.41408050 6 D0516 0.13569370 0.10673380 7 D0603 0.05839395 0.02798604 8 D0611 0.05319545 0.03150427 9 D0817 0.05929974 0.03891495 10 D0819 0.04918472 0.02337847 Function 1 Amino acid biosynthesis_GABA 2 SCFA biosynthesis_Acetate 3 Vitamin biosynthesis_Tocopherol/tocotorienol (E) 4 Polysaccharide degradation_Alpha-mannan 5 Amino acid degradation_Valine 6 Amino acid degradation_Beta-alanine 7 Nitrogen compound degradation_Urate 8 Nitrogen compound degradation_Phenylethylamine 9 Xenobiotic degradation_Trans-cinnamate 10 Xenobiotic degradation_Mercury difference_table &lt;- element_gift_filt %&gt;% select(-sample) %&gt;% group_by(season) %&gt;% summarise(across(everything(), mean)) %&gt;% t() %&gt;% row_to_names(row_number = 1) %&gt;% as.data.frame() %&gt;% mutate_if(is.character, as.numeric) %&gt;% rownames_to_column(., &quot;Elements&quot;) %&gt;% left_join(.,uniqueGIFT_db[c(1,3,4)],by = join_by(Elements == Code_element)) %&gt;% arrange(Function) %&gt;% mutate(Difference=summer-winter)%&gt;% mutate(group_color = ifelse(Difference &lt;0, &quot;winter&quot;,&quot;summer&quot;)) Neutral sample_metadata_row&lt;- column_to_rownames(sample_metadata, &quot;sample&quot;) sample_metadata_row &lt;- sample_metadata_row[labels(beta_q1n$S), ] betadisper(beta_q1n$S, sample_metadata_row$individual) %&gt;% permutest(., pairwise = TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 42 0 0 NaN 999 Residuals 0 0 NaN Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) SD03146 SD03147 SD03148 SD03149 SD03150 SD03151 SD03152 SD03153 SD03159 SD03146 SD03147 SD03148 SD03149 SD03150 SD03151 SD03152 SD03153 SD03159 SD03160 SD03161 SD03162 SD03163 SD03164 SD03168 SD03169 SD03170 SD03171 SD03172 SD03173 SD03174 SD03175 SD03176 SD03177 SD03178 SD03228 SD03229 SD03230 SD03231 SD05290 SD05291 SD05292 SD05293 SD05295 SD05296 SD05297 SD05298 SD05299 SD05300 SD05301 SD05302 SD05303 SD05304 SD03160 SD03161 SD03162 SD03163 SD03164 SD03168 SD03169 SD03170 SD03171 SD03146 SD03147 SD03148 SD03149 SD03150 SD03151 SD03152 SD03153 SD03159 SD03160 SD03161 SD03162 SD03163 SD03164 SD03168 SD03169 SD03170 SD03171 SD03172 SD03173 SD03174 SD03175 SD03176 SD03177 SD03178 SD03228 SD03229 SD03230 SD03231 SD05290 SD05291 SD05292 SD05293 SD05295 SD05296 SD05297 SD05298 SD05299 SD05300 SD05301 SD05302 SD05303 SD05304 SD03172 SD03173 SD03174 SD03175 SD03176 SD03177 SD03178 SD03228 SD03229 SD03146 SD03147 SD03148 SD03149 SD03150 SD03151 SD03152 SD03153 SD03159 SD03160 SD03161 SD03162 SD03163 SD03164 SD03168 SD03169 SD03170 SD03171 SD03172 SD03173 SD03174 SD03175 SD03176 SD03177 SD03178 SD03228 SD03229 SD03230 SD03231 SD05290 SD05291 SD05292 SD05293 SD05295 SD05296 SD05297 SD05298 SD05299 SD05300 SD05301 SD05302 SD05303 SD05304 SD03230 SD03231 SD05290 SD05291 SD05292 SD05293 SD05295 SD05296 SD05297 SD03146 SD03147 SD03148 SD03149 SD03150 SD03151 SD03152 SD03153 SD03159 SD03160 SD03161 SD03162 SD03163 SD03164 SD03168 SD03169 SD03170 SD03171 SD03172 SD03173 SD03174 SD03175 SD03176 SD03177 SD03178 SD03228 SD03229 SD03230 SD03231 SD05290 SD05291 SD05292 SD05293 SD05295 SD05296 SD05297 SD05298 SD05299 SD05300 SD05301 SD05302 SD05303 SD05304 SD05298 SD05299 SD05300 SD05301 SD05302 SD05303 SD05304 SD03146 SD03147 SD03148 SD03149 SD03150 SD03151 SD03152 SD03153 SD03159 SD03160 SD03161 SD03162 SD03163 SD03164 SD03168 SD03169 SD03170 SD03171 SD03172 SD03173 SD03174 SD03175 SD03176 SD03177 SD03178 SD03228 SD03229 SD03230 SD03231 SD05290 SD05291 SD05292 SD05293 SD05295 SD05296 SD05297 SD05298 SD05299 SD05300 SD05301 SD05302 SD05303 SD05304 adonis2(beta_q1n$S ~ day+individual, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() /* tinytable css entries after */ .table td.tinytable_css_ino4kz42t53sec67vsse, .table th.tinytable_css_ino4kz42t53sec67vsse { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_1wy8tfk1jkssdkh04buc, .table th.tinytable_css_1wy8tfk1jkssdkh04buc { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Model 42 5.325585 1 NA NA Residual 0 0.000000 0 NA NA Total 42 5.325585 1 NA NA pairwise.adonis(beta_q1n$S, sample_metadata$day, perm = 999) pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1 Unknown vs day_1 1 0.3060651 2.499973 0.05747069 0.006 0.006 * "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
